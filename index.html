<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta name="description" content="一个非主流程序员">
<meta property="og:type" content="website">
<meta property="og:title" content="柿子的果盘">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="柿子的果盘">
<meta property="og:description" content="一个非主流程序员">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="柿子的果盘">
<meta name="twitter:description" content="一个非主流程序员">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title>柿子的果盘</title>
  
<script>
  window.fbAsyncInit = function() {
    FB.init({
      appId      : '328629287562794',
      xfbml      : true,
      version    : 'v2.6'
    });
  };

  (function(d, s, id){
     var js, fjs = d.getElementsByTagName(s)[0];
     if (d.getElementById(id)) {return;}
     js = d.createElement(s); js.id = id;
     js.src = "//connect.facebook.net/zh_Hans/sdk.js";
     fjs.parentNode.insertBefore(js, fjs);
   }(document, 'script', 'facebook-jssdk'));
</script>






  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?30798a6e72702e12c529efb9326dc7e1";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>










</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">柿子的果盘</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">随手记录一些所读、所思、所感</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/07/31/redis_4_lfu/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="柿子">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="柿子的果盘">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/31/redis_4_lfu/" itemprop="url">Redis 4.0 新功能：LFU 数据淘汰策略</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-31T00:00:00+08:00">
                2017-07-31
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/开源项目/" itemprop="url" rel="index">
                    <span itemprop="name">开源项目</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/07/31/redis_4_lfu/#comments" itemprop="discussionUrl">
                  评论数 <span class="post-comments-count fb-comments-count" data-href="http://yoursite.com/2017/07/31/redis_4_lfu/" itemprop="commentCount">0</span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/07/31/redis_4_lfu/" class="leancloud_visitors" data-flag-title="Redis 4.0 新功能：LFU 数据淘汰策略">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="常用淘汰算法"><a href="#常用淘汰算法" class="headerlink" title="常用淘汰算法"></a>常用淘汰算法</h3><p>淘汰算法的核心是预测数据未来被访问的可能性，优先淘汰概率最低的。<br>常用的淘汰算法有三种：</p>
<ul>
<li>FIFO：核心原则是如果数据最先进入缓存，则最先被淘汰，实现简单，但是太暴力</li>
<li>LRU：核心原则是最近没有被使用的数据，在未来被使用的可能性也最低，最先淘汰</li>
<li>LFU：核心原则是最近使用频率最低的数据，在未来被使用的可能性也最低，最先淘汰</li>
</ul>
<h3 id="Redis-LRU-实现"><a href="#Redis-LRU-实现" class="headerlink" title="Redis LRU 实现"></a>Redis LRU 实现</h3><p>在 Redis 中实现的 LRU 算法使用了一些比较 tricky 的策略用来提升性能：</p>
<ul>
<li>并不是取所有数据中访问时间最早的，而是随机选取 N 个数据项，淘汰掉时间最早的</li>
<li>使用随机选取的 N 个数据项建立备选池，只有当数据老于这个池中最老的数据，才会发生更替</li>
</ul>
<p>在 Redis 4.0 的改版中，antirez 还针对使用多个 Redis 数据库做缓存做了优化，在老的版本中，多个数据库各自维护备选池，而在新的版本中，多个数据库维护一个共有的备选池，数据项额外加上数据库 ID。这样可以避免某一些数据库存储的都是老数据，另一些数据库存储的都是新数据的情况。</p>
<h3 id="Redis-LFU-实现"><a href="#Redis-LFU-实现" class="headerlink" title="Redis LFU 实现"></a>Redis LFU 实现</h3><p>在经过多轮优化尝试没有获得提升效果以后，antirez 认为这是 LRU 策略本身的短板，于是开始考虑实现 LFU 策略。他认为，从策略角度来看，LRU 是 LFU 的一种简化版。<br>在实现过程中，存在两个问题：</p>
<ul>
<li>在 LRU 中，由于只要根据最近访问时间进行判断，这样可以使用一个链表，以及 O(1) 时间复杂度的操作进行维护，但是 LFU 需要维护所有数据的访问次数</li>
<li>LFU 不能只保存访问次数，因为访问的模式会在变化，所以每隔一段时间，需要对访问次数对应的分值进行调整，而 Redis 中只保留了24 bits 来支持数据淘汰策略</li>
</ul>
<p>对于第一个问题，antirez 沿用了 LRU 的处理方法：不严格按照访问次数进行维护，而是在需要选择淘汰数据的时候，随机采样 N 个数据项，淘汰掉次数最少的（感觉 antirez 很喜欢用随机采样进行近似，并且认为这个近似是有效的）<br>对于第二个问题，antirez 按照这样的方式分配 24 bits，其中 16 bits 用于记录最后调整计数器的时间，8 bits 用于记录计数器。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">+----------------+--------+</div><div class="line">+     16 bits    | 8 bits +</div><div class="line">+----------------+--------+</div><div class="line">+ Last decr time | LOG_C  |</div><div class="line">+----------------+--------+</div></pre></td></tr></table></figure></p>
<p>在计数器部分，antirez 使用了对数效果的计数器（使用概率的方式达到类似对数的效果），具体实现如下：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">uint8_t</span> LFULogIncr(<span class="keyword">uint8_t</span> counter) &#123;</div><div class="line">    <span class="keyword">if</span> (counter == <span class="number">255</span>) <span class="keyword">return</span> <span class="number">255</span>;</div><div class="line">    <span class="keyword">double</span> r = (<span class="keyword">double</span>)rand()/RAND_MAX;</div><div class="line">    <span class="keyword">double</span> baseval = counter - LFU_INIT_VAL;</div><div class="line">    <span class="keyword">if</span> (baseval &lt; <span class="number">0</span>) baseval = <span class="number">0</span>;</div><div class="line">    <span class="keyword">double</span> p = <span class="number">1.0</span>/(baseval*server.lfu_log_factor+<span class="number">1</span>);</div><div class="line">    <span class="keyword">if</span> (r &lt; p) counter++;</div><div class="line">    <span class="keyword">return</span> counter;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>调整计数器的时机是在随机采样的时候，如果具体上次的调整时间已经超过阈值，且计数器的值超过阈值，则将计数器的值减半。<br>此外，对于新数据，分配的计数器是 5，而不是 0，否则新数据大概率被淘汰，从而导致策略失效。</p>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><ul>
<li><a href="http://antirez.com/news/109" target="_blank" rel="external">Random notes on improving the Redis LRU algorithm</a></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/07/31/redis_4_mix_persistancy/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="柿子">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="柿子的果盘">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/31/redis_4_mix_persistancy/" itemprop="url">Redis 4.0 新功能：混合持久化</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-31T00:00:00+08:00">
                2017-07-31
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/开源项目/" itemprop="url" rel="index">
                    <span itemprop="name">开源项目</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/07/31/redis_4_mix_persistancy/#comments" itemprop="discussionUrl">
                  评论数 <span class="post-comments-count fb-comments-count" data-href="http://yoursite.com/2017/07/31/redis_4_mix_persistancy/" itemprop="commentCount">0</span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/07/31/redis_4_mix_persistancy/" class="leancloud_visitors" data-flag-title="Redis 4.0 新功能：混合持久化">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Redis 的读写都是在内存中进行的，持久化数据只是作为磁盘备份，当实例重启或者机器断电的时候可以从磁盘加载数据到内存中。<br>目前 Redis 支持的持久化方式有两种：RDB 和 AOF。</p>
<h4 id="RDB"><a href="#RDB" class="headerlink" title="RDB"></a>RDB</h4><p>RDB 是将某一时刻 Redis 中保存的数据全部写到磁盘中，在这个时刻之后写入的数据就会丢失掉。</p>
<h4 id="AOF"><a href="#AOF" class="headerlink" title="AOF"></a>AOF</h4><p>AOF 是将 Redis 的写入命令持久化到磁盘中，根据策略的不同，持久化的时机也不同：</p>
<ul>
<li>appendfsync = always 每条写入都会刷盘, 最多只会丢失当前正在写入的命令</li>
<li>appendfsync = everysec 每秒刷一次盘, 最多丢失一秒的数据</li>
<li>appendfsync = no 不显式刷盘，由操作系统来决定何时刷盘 (linux 貌似大部分默认是 30s)，可能会丢失刷盘之前的写入数据</li>
</ul>
<h4 id="两者对比"><a href="#两者对比" class="headerlink" title="两者对比"></a>两者对比</h4><p>进行 RDB 持久化以后，由于只保存数据，所以持久化过程比较快，持久化文件比较小，重新载入速度快，缺点是会丢失备份以后写入的数据；而 AOF 需要保存所有的写入命令，丢失数据量比较小，缺点是当频繁写入，或开机时间很长以后，持久化文件比较大，重新载入速度慢。</p>
<h4 id="混合持久化"><a href="#混合持久化" class="headerlink" title="混合持久化"></a>混合持久化</h4><p>Redis 4.0 开始支持混合持久化，AOF 重写的时候就直接把 RDB 的内容写到 AOF 文件开头，其中 RDB 格式的内容用于记录已有的数据， 而 AOF 格式的内存则用于记录最近发生了变化的数据， 这样 Redis 就可以同时兼有 RDB 持久化和 AOF 持久化的优点 —— 既能够快速地生成重写文件，也能够在出现问题时， 快速地载入数据。<br>AOF 重写机制：由于 AOF 是通过不断追加写命令来记录数据库状态，所以服务器执行比较久之后，AOF 文件中的内容会越来越多，磁盘占有量越来越大，同时也是使通过过aof文件还原数据库的需要的时间也变得很久。所以就需要通过读取服务器当前的数据库状态来重写新的 AOF 文件。而混合持久化就是在重写的文件中将 RDB 内容写入。<br>具体实现如下：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// aof_use_rdb_preamble = 1 表示打开混合存储模式</span></div><div class="line"><span class="keyword">if</span> (server.aof_use_rdb_preamble) &#123;</div><div class="line">    <span class="keyword">int</span> error;</div><div class="line">    <span class="comment">// aof 文件前面部分就是直接写入 rdb 文件</span></div><div class="line">    <span class="keyword">if</span> (rdbSaveRio(&amp;aof,&amp;error,RDB_SAVE_AOF_PREAMBLE,<span class="literal">NULL</span>) == C_ERR) &#123;</div><div class="line">        errno = error;</div><div class="line">        <span class="keyword">goto</span> werr;</div><div class="line">    &#125;</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">    <span class="comment">// 如果是关闭混合存储和之前一样，保持 aof 格式</span></div><div class="line">    <span class="keyword">if</span> (rewriteAppendOnlyFileRio(&amp;aof) == C_ERR) <span class="keyword">goto</span> werr;</div><div class="line">&#125;</div><div class="line"><span class="comment">// 后续的逻辑与之前一样，处理父进程中写入缓冲区的数据</span></div></pre></td></tr></table></figure></p>
<p>重写期间，主进程继续处理命令，对数据库状态进行修改，这样使得当前的数据库状态与重写的 AOF 文件所保存的数据库状态不一致。因此，Redis 设置了 AOF 重写缓冲区，在创建子进程后，主进程每执行一个写命令都会写到重写缓冲区。在子进程完成重写后，主进程会将 AOF 重写缓冲区的数据写入到重写的 AOF 文件，保证数据状态的一致。<br>因此，可以理解为 RDB 格式的数据是重写开始那个时刻的数据库状态，而 AOF 格式的数据是在重写期间，主进程中的 AOF 重写缓冲区中的数据。</p>
<h4 id="混合加载"><a href="#混合加载" class="headerlink" title="混合加载"></a>混合加载</h4><p>开启混合存储模式后 AOF 文件加载的流程如下（判断开头是不是 RDB 格式是看初始的五个字符是不是 REDIS）：</p>
<ul>
<li>AOF 文件开头是 RDB 的格式, 先加载 RDB 内容再加载剩余的 AOF</li>
<li>AOF 文件开头不是 RDB 的格式，直接以 AOF 格式加载整个文件</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">char</span> sig[<span class="number">5</span>]; <span class="comment">/* "REDIS" */</span></div><div class="line"><span class="keyword">if</span> (fread(sig,<span class="number">1</span>,<span class="number">5</span>,fp) != <span class="number">5</span> || <span class="built_in">memcmp</span>(sig,<span class="string">"REDIS"</span>,<span class="number">5</span>) != <span class="number">0</span>) &#123;</div><div class="line">    <span class="comment">// 前部分内容不是 rdb 格式，不是混合持久化的方式</span></div><div class="line">    <span class="keyword">if</span> (fseek(fp,<span class="number">0</span>,SEEK_SET) == <span class="number">-1</span>) <span class="keyword">goto</span> readerr;</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">    rio rdb;</div><div class="line"></div><div class="line">    serverLog(LL_NOTICE,<span class="string">"Reading RDB preamble from AOF file..."</span>);</div><div class="line">    <span class="keyword">if</span> (fseek(fp,<span class="number">0</span>,SEEK_SET) == <span class="number">-1</span>) <span class="keyword">goto</span> readerr;</div><div class="line">    rioInitWithFile(&amp;rdb,fp);</div><div class="line">    <span class="comment">// 前面部分是 rdb 格式说明是混合持久化，先加载 rdb 后面逻辑再加载 aof</span></div><div class="line">    <span class="keyword">if</span> (rdbLoadRio(&amp;rdb,<span class="literal">NULL</span>) != C_OK) &#123;</div><div class="line">        serverLog(LL_WARNING,<span class="string">"Error reading the RDB preamble of the AOF file, AOF loading aborted"</span>);</div><div class="line">        <span class="keyword">goto</span> readerr;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        serverLog(LL_NOTICE,<span class="string">"Reading the remaining AOF tail..."</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">...</div><div class="line"><span class="comment">// 加载 aof 格式的数据</span></div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/07/30/redis_4_psync/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="柿子">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="柿子的果盘">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/30/redis_4_psync/" itemprop="url">Redis 4.0 新功能：PSYNC 优化</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-30T00:00:00+08:00">
                2017-07-30
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/开源项目/" itemprop="url" rel="index">
                    <span itemprop="name">开源项目</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/07/30/redis_4_psync/#comments" itemprop="discussionUrl">
                  评论数 <span class="post-comments-count fb-comments-count" data-href="http://yoursite.com/2017/07/30/redis_4_psync/" itemprop="commentCount">0</span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/07/30/redis_4_psync/" class="leancloud_visitors" data-flag-title="Redis 4.0 新功能：PSYNC 优化">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Redis 支持 Master-Slave（主从）模式，Redis Server 可以设置为另一个 Redis Server 的主机（从机），从机定期从主机拿数据。特殊的，一个从机同样可以设置为一个 Redis Server 的主机，如此形成 Redis Server 集群，无论是主机还是从机都是 Redis Server，都可以提供服务。在主机和从机之间需要同步数据，随着 Redis 版本的增加，同步机制也在不断发生变化。</p>
<h3 id="全量同步"><a href="#全量同步" class="headerlink" title="全量同步"></a>全量同步</h3><p>在 Redis 2.8 以前，Redis 只支持全量同步，分为同步（SYNC）和命令传播（COMMAND PROPAGATE）两个操作：</p>
<ul>
<li>同步操作用于将从机的数据库状态更新至主机当前所处的数据库状态，具体实现主要是通过在主机执行 BGSAVE 命令生成 RDB 文件，在此之后的写命令存储到缓冲区</li>
<li>命令传播则用于在主机数据库状态被修改时，让主从数据库回到一致状态，具体实现主要是主机将自己执行的写命令发送给从机执行</li>
</ul>
<p>对于初次复制来说，这样的同步机制可以很好地完成任务，但是对于断线后的复制而言，由于还是要进行全量复制，因此效率特别低下。主要耗时的原因在于 SYNC 命令：</p>
<ul>
<li>主机需要执行 BGSAVE 命令生成 RDB 文件，耗费大量 CPU、内存和磁盘 I/O 资源</li>
<li>主机需要将生成的 RDB 文件发送给从服务器，耗费大量的带宽，导致服务响应时间变长</li>
<li>从机需要载入 RDB 文件导致阻塞</li>
</ul>
<p>因此，优化同步机制的方向是尽量在有需要的时候才真正执行 SYNC 命令，而针对断线重连的情况，如果从机已经存有主机大量的数据，只是少部分数据没有的话，使用 SYNC 命令进行则非常浪费。</p>
<h3 id="PSYNC-机制"><a href="#PSYNC-机制" class="headerlink" title="PSYNC 机制"></a>PSYNC 机制</h3><p>在 Redis 2.8 中引入了 PSYNC 机制，它的基础是：</p>
<ul>
<li>主机和从机分别维护一个复制偏移量，通过对比主从机的复制偏移量，很容易判断是否处于一致状态；</li>
<li>主机维护一个复制积压缓冲区，存储一定数量的写命令</li>
<li>每个 Redis 服务器，都有自己的 runid，连接时，从机会获得主机的 runid</li>
</ul>
<p>有了这些基础条件，可以按照如下的条件来判断是否需要全量同步：</p>
<ul>
<li>从机保存的主机 runID 和当前主机的 runID 是否一致</li>
<li>从机维护的复制偏移量与主机的差值是否超过复制积压缓冲区里的命令个数</li>
</ul>
<p>经过上述的判断，如果需要全量同步，则返回 +FULLRESYNC runid offset，否则返回 +CONTINUE 进行增量同步。<br>通过上述的优化，可以解决短时间的主从同步断线重连的问题，但是在如下的场景中，仍然需要全量同步：</p>
<ul>
<li>主从机有重启过，因为 runid 重启后就会丢失，所以无法进行增量同步</li>
<li>从机被提升为主机，其它从机切换到新的主机需要全量同步，因为 新老主机的 runid 不同</li>
</ul>
<h3 id="PSYNC-机制优化"><a href="#PSYNC-机制优化" class="headerlink" title="PSYNC 机制优化"></a>PSYNC 机制优化</h3><p>为了解决主从角色切换导致的重新全量同步，Redis 4.0 引入一个新变量 replid2 来存放同步过的主机的 replid，replid 在主机的意义和之前 replid 仍然是一样的，但对于从机来说，replid 表示当前正在同步的主库的 replid 而不再是本身的 replid。replid2 则表示前一个主库的 replid，这个在主从角色切换的时候会用到。<br>同时，增加了一些主机判断是否允许进行增量同步的条件：</p>
<ul>
<li>从机发送过来的 replid 是当前实例的 replid，说明之前就是这个实例的从库，或者</li>
<li>从机发送过来的 replid 是当前实例的 replid2，说明两者之前曾经属于同一个主机，而且两者的复制偏移量差距不能超过限制</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (strcasecmp(master_replid, server.replid) &amp;&amp;</div><div class="line">    (strcasecmp(master_replid, server.replid2) ||</div><div class="line">        psync_offset &gt; server.second_replid_offset)) &#123;</div><div class="line">    ...</div><div class="line">    <span class="keyword">goto</span> need_full_resync;</div><div class="line">｝</div></pre></td></tr></table></figure>
<p>此外，在做 RDB 备份的时候，replid、replid2 和 offset 会被持久化到 rdb 文件里面，这样即使服务重启了，也可以进行增量同步。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/07/30/redis_4_async_delete/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="柿子">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="柿子的果盘">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/30/redis_4_async_delete/" itemprop="url">Redis 4.0 新功能：非阻塞删除</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-30T00:00:00+08:00">
                2017-07-30
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/开源项目/" itemprop="url" rel="index">
                    <span itemprop="name">开源项目</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/07/30/redis_4_async_delete/#comments" itemprop="discussionUrl">
                  评论数 <span class="post-comments-count fb-comments-count" data-href="http://yoursite.com/2017/07/30/redis_4_async_delete/" itemprop="commentCount">0</span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/07/30/redis_4_async_delete/" class="leancloud_visitors" data-flag-title="Redis 4.0 新功能：非阻塞删除">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="现存的问题"><a href="#现存的问题" class="headerlink" title="现存的问题"></a>现存的问题</h3><p>Redis 基于单线程模型，因此一些耗时比较严重（通常是遍历整张表）的操作会阻塞其它命令的执行。对于某些命令而言（例如 BGSAVE），Redis 会通过新开线程，或者后台操作来避免这种阻塞。而类似 KEYS / FLUSHALL / FLUSHDB 等命令，通常在生产环境下我们也会直接禁用。但是像 DEL / LRANGE / HGETALL 这些可能导致阻塞的命令经常被忽视，而这些命令在 value 比较大的时候跟 KEYS 这些并没有本质区别（例如 value 是链表，集合或者字典，同样要遍历删除）。</p>
<h3 id="优化方式"><a href="#优化方式" class="headerlink" title="优化方式"></a>优化方式</h3><p>在 Redis 4.0 中，对 DEL / FLUSHALL / FLUSHDB 这些命令进行了优化：FLUSHALL / FLUSHDB 加了一个 ASYNC 参数，同时新增 UNLINK 来表示异步化的删除命令（DEL 命令是支持不定参数，如果加个 ASYNC 参数没办法判断到底这个是 key 还是异步删除的选项，所以索性增加了一个新命令）。</p>
<h3 id="UNLINK-具体实现"><a href="#UNLINK-具体实现" class="headerlink" title="UNLINK 具体实现"></a>UNLINK 具体实现</h3><p>我们可看到 UNLINK 命令会调用 dbAsyncDelete 来实现异步调用。在 dbAsyncDelete 中，并不是所有的键值对的删除都是异步的，而是对于 value 进行评估，如果超过阈值，则放入异步队列中进行处理。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">unlinkCommand</span><span class="params">(client *c)</span> </span>&#123;</div><div class="line">    <span class="comment">// lazy 参数设置 1，表示异步删除</span></div><div class="line">    delGenericCommand(c,<span class="number">1</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">delGenericCommand</span><span class="params">(client *c, <span class="keyword">int</span> lazy)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> numdel = <span class="number">0</span>, j;</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (j = <span class="number">1</span>; j &lt; c-&gt;argc; j++) &#123;</div><div class="line">        expireIfNeeded(c-&gt;db,c-&gt;argv[j]);</div><div class="line">        <span class="comment">// 如果是异步删除调用 dbAsyncDelete</span></div><div class="line">        <span class="keyword">int</span> deleted  = lazy ? dbAsyncDelete(c-&gt;db,c-&gt;argv[j]) :</div><div class="line">                              dbSyncDelete(c-&gt;db,c-&gt;argv[j]);</div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line">    addReplyLongLong(c,numdel);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> LAZYFREE_THRESHOLD 64</span></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">dbAsyncDelete</span><span class="params">(redisDb *db, robj *key)</span> </span>&#123;</div><div class="line">    <span class="comment">// 先把 key 从过期时间字典里面删除</span></div><div class="line">    <span class="keyword">if</span> (dictSize(db-&gt;expires) &gt; <span class="number">0</span>) dictDelete(db-&gt;expires,key-&gt;ptr);</div><div class="line">    <span class="comment">// 把 kv 从字典里面摘除但不是删除 value，后续命令就查询不到</span></div><div class="line">    dictEntry *de = dictUnlink(db-&gt;dict,key-&gt;ptr);</div><div class="line">    <span class="keyword">if</span> (de) &#123;</div><div class="line">        robj *val = dictGetVal(de);</div><div class="line">        <span class="comment">// 不是所有的 key 都会走异步化删除，如果 value 比较小会直接删除</span></div><div class="line">        <span class="comment">// 如果 value 是字典/链表/集合且不能是压缩的返回对应的元素数目，其他都返回 1</span></div><div class="line">        <span class="keyword">size_t</span> free_effort = lazyfreeGetFreeEffort(val);</div><div class="line"></div><div class="line">        <span class="comment">// 只有计算出来的 free_effort 大于 LAZYFREE_THRESHOLD(64) 才会进入异步处理</span></div><div class="line">        <span class="keyword">if</span> (free_effort &gt; LAZYFREE_THRESHOLD) &#123;</div><div class="line">            atomicIncr(lazyfree_objects,<span class="number">1</span>,lazyfree_objects_mutex);</div><div class="line">            <span class="comment">// 创建 BIO_LAZY_FREE 任务，放到异步队列</span></div><div class="line">            bioCreateBackgroundJob(BIO_LAZY_FREE,val,<span class="literal">NULL</span>,<span class="literal">NULL</span>);</div><div class="line">            dictSetVal(db-&gt;dict,de,<span class="literal">NULL</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (de) &#123;<span class="comment">// 如果 key 存在，释放字典里面结构</span></div><div class="line">        dictFreeUnlinkedEntry(db-&gt;dict,de);</div><div class="line">        <span class="keyword">if</span> (server.cluster_enabled) slotToKeyDel(key);</div><div class="line">        <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="FLUSHALL-FLUSHDB-具体实现"><a href="#FLUSHALL-FLUSHDB-具体实现" class="headerlink" title="FLUSHALL / FLUSHDB 具体实现"></a>FLUSHALL / FLUSHDB 具体实现</h3><p>Redis 会先检查这两个命令是否有带 ASYNC ，接着在 emptyDb 判断是异步清数据，如果是异步清除则会调用 emptyDbAsync。<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">int getFlushCommandFlags(client *c, int *flags) &#123;</div><div class="line">    if (c-&gt;argc &gt; 1) &#123;</div><div class="line">        // 判断第二个参数是否为 async</div><div class="line">        if (c-&gt;argc &gt; 2 || strcasecmp(c-&gt;argv[1]-&gt;ptr,"async")) &#123;</div><div class="line">            addReply(c,shared.syntaxerr);</div><div class="line">            return C_ERR;</div><div class="line">        &#125;</div><div class="line">        *flags = EMPTYDB_ASYNC;</div><div class="line">    &#125; else &#123;</div><div class="line">        *flags = EMPTYDB_NO_FLAGS;</div><div class="line">    &#125;</div><div class="line">    return C_OK;</div><div class="line">&#125;</div><div class="line"></div><div class="line">long long emptyDb(int dbnum, int flags, void(callback)(void*) ) &#123;</div><div class="line"> if (async) &#123;</div><div class="line"> emptyDbAsnyc(&amp;server.db[j]);</div><div class="line"> &#125; else &#123;</div><div class="line"> dictEmpty(server.db[j].dict, callback);</div><div class="line"> dictEmpty(server.db[j].expires, callback);</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">void emptyDbAsync(redisDb *db) &#123;</div><div class="line">    // 保留老的数据库指针并重新创建新的数据库</div><div class="line">    dict *oldht1 = db-&gt;dict, *oldht2 = db-&gt;expires;</div><div class="line">    db-&gt;dict = dictCreate(&amp;dbDictType,NULL);</div><div class="line">    db-&gt;expires = dictCreate(&amp;keyptrDictType,NULL);</div><div class="line">    atomicIncr(lazyfree_objects,dictSize(oldht1),</div><div class="line">        lazyfree_objects_mutex);</div><div class="line">    // 把要清空的 db 作为一个 job 添加到后台的处理队列</div><div class="line">    bioCreateBackgroundJob(BIO_LAZY_FREE,NULL,oldht1,oldht2);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/07/29/redis_4_module/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="柿子">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="柿子的果盘">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/29/redis_4_module/" itemprop="url">Redis 4.0 新功能：模块系统</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-29T00:00:00+08:00">
                2017-07-29
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/开源项目/" itemprop="url" rel="index">
                    <span itemprop="name">开源项目</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/07/29/redis_4_module/#comments" itemprop="discussionUrl">
                  评论数 <span class="post-comments-count fb-comments-count" data-href="http://yoursite.com/2017/07/29/redis_4_module/" itemprop="commentCount">0</span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/07/29/redis_4_module/" class="leancloud_visitors" data-flag-title="Redis 4.0 新功能：模块系统">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="引入模块的动机"><a href="#引入模块的动机" class="headerlink" title="引入模块的动机"></a>引入模块的动机</h3><p>Redis 4.0 中出现的最大的变化，也是促使 antirez 不使用 3.4，而是直接使用 4.0 来标记这个版本的原因，就是引入模块系统。<br>其实早在 Redis 1.0 发布的时候，antirez 就在未来可能引入的功能里提到了“可载入的模块”，但是在后续的版本中一直没有实现。他自述的理由如下：</p>
<ul>
<li>不同版本的 API 的兼容性问题</li>
<li>低质量的模块可能造成的系统冲突</li>
<li>缺乏可拓展的模块标识系统</li>
</ul>
<p>因此，从 Redis 1.0 发布以后，antirez 一直都在使用 LUA 脚本来实现功能。<br>但正是由于这些实践，让他发现使用脚本开发只能组合已有的功能，并不能有效地拓展当前框架下没有的功能，于是下定决心写一个模块系统。<br>设计这个模块系统最难的，也是工作量最大的点在于：需要对于 Redis 内核进行封装，使得 API 独立于 Redis 内核，达到 Redis 内核升级以后也不会影响已经开发好的模块。</p>
<h3 id="模块加载"><a href="#模块加载" class="headerlink" title="模块加载"></a>模块加载</h3><p>可以在 redis.conf 中配置载入模块：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">loadmodule &lt;path&gt; [args...]</div></pre></td></tr></table></figure></p>
<p>或者在运行时动态载入模块：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">MODULE LOAD &lt;path&gt; [args...]</div></pre></td></tr></table></figure></p>
<p>可以来看看 MODULE LOAD 命令的内部实现 (module.c)，主要分为如下几个步骤：</p>
<ul>
<li>加载指定路径的动态库</li>
<li>检查并回调模块实现的 RedisModule_OnLoad 函数</li>
<li>注册模块到模块列表，方便后续卸载</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">moduleLoad</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *path, <span class="keyword">void</span> **module_argv, <span class="keyword">int</span> module_argc)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> (*onload)(<span class="keyword">void</span> *, <span class="keyword">void</span> **, <span class="keyword">int</span>);</div><div class="line">    <span class="keyword">void</span> *handle;</div><div class="line">    RedisModuleCtx ctx = REDISMODULE_CTX_INIT;</div><div class="line"></div><div class="line">    <span class="comment">// 加载指定路径的动态库</span></div><div class="line">    handle = dlopen(path,RTLD_NOW|RTLD_LOCAL);</div><div class="line">    <span class="keyword">if</span> (handle == <span class="literal">NULL</span>) &#123;</div><div class="line">        serverLog(LL_WARNING, <span class="string">"Module %s failed to load: %s"</span>, path, dlerror());</div><div class="line">        <span class="keyword">return</span> C_ERR;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 检查 RedisModule_OnLoad 函数是否实现</span></div><div class="line">    onload = (<span class="keyword">int</span> (*)(<span class="keyword">void</span> *, <span class="keyword">void</span> **, <span class="keyword">int</span>))(<span class="keyword">unsigned</span> <span class="keyword">long</span>) dlsym(handle,<span class="string">"RedisModule_OnLoad"</span>);</div><div class="line">    <span class="keyword">if</span> (onload == <span class="literal">NULL</span>) &#123;</div><div class="line">        serverLog(LL_WARNING,</div><div class="line">            <span class="string">"Module %s does not export RedisModule_OnLoad() "</span></div><div class="line">            <span class="string">"symbol. Module not loaded."</span>,path);</div><div class="line">        <span class="keyword">return</span> C_ERR;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 回调模块的 RedisModule_OnLoad 函数</span></div><div class="line">    <span class="keyword">if</span> (onload((<span class="keyword">void</span>*)&amp;ctx,module_argv,module_argc) == REDISMODULE_ERR) &#123;</div><div class="line">        <span class="keyword">if</span> (ctx.<span class="keyword">module</span>) moduleFreeModuleStructure(ctx.<span class="keyword">module</span>);</div><div class="line">        dlclose(handle);</div><div class="line">        serverLog(LL_WARNING,</div><div class="line">            <span class="string">"Module %s initialization failed. Module not loaded"</span>,path);</div><div class="line">        <span class="keyword">return</span> C_ERR;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 注册模块到模块列表，方便后续卸载</span></div><div class="line">    dictAdd(modules,ctx.<span class="keyword">module</span>-&gt;name,ctx.<span class="keyword">module</span>);</div><div class="line">    ctx.<span class="keyword">module</span>-&gt;handle = handle;</div><div class="line">    serverLog(LL_NOTICE,<span class="string">"Module '%s' loaded from %s"</span>,ctx.<span class="keyword">module</span>-&gt;name,path);</div><div class="line">    moduleFreeContext(&amp;ctx);</div><div class="line">    <span class="keyword">return</span> C_OK;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="编写模块"><a href="#编写模块" class="headerlink" title="编写模块"></a>编写模块</h3><p>模块必须实现 RedisModule_OnLoad，以便在 Redis 调用模块的时候正确处理模块的初始化。以下是一个简单地模块：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">#include &quot;redismodule.h&quot;</div><div class="line">#include &lt;stdlib.h&gt;</div><div class="line"></div><div class="line">int HelloworldRand_RedisCommand(RedisModuleCtx *ctx, RedisModuleString **argv, int argc) &#123;</div><div class="line">    RedisModule_ReplyWithLongLong(ctx,rand());</div><div class="line">    return REDISMODULE_OK;</div><div class="line">&#125;</div><div class="line"></div><div class="line">int RedisModule_OnLoad(RedisModuleCtx *ctx, RedisModuleString **argv, int argc) &#123;</div><div class="line">    if (RedisModule_Init(ctx,&quot;helloworld&quot;,1,REDISMODULE_APIVER_1)</div><div class="line">        == REDISMODULE_ERR) return REDISMODULE_ERR;</div><div class="line"></div><div class="line">    if (RedisModule_CreateCommand(ctx,&quot;helloworld.rand&quot;,</div><div class="line">        HelloworldRand_RedisCommand) == REDISMODULE_ERR)</div><div class="line">        return REDISMODULE_ERR;</div><div class="line"></div><div class="line">    return REDISMODULE_OK;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在 RedisModule_OnLoad 中主要进行了两个任务：</p>
<ul>
<li>模块初始化：调用 RedisModule_Init 函数，将 Redis 对外提供的接口暴露给模块使用</li>
<li>添加命令到 Redis，整合模块提供的功能到 Redis 的命令处理过程中<br>这是 Redis 内部实现创建 Command 的函数，它的主要逻辑是：创建一个 RedisModuleCommandProxy 并把它的 rediscmd 作为命令的处理函数。<br>而在 RedisModuleCommandDispatcher 中，会先创建上下文，调用具体的实现函数，然后调用 callback，销毁上下文。</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">RM_CreateCommand</span><span class="params">(RedisModuleCtx *ctx, <span class="keyword">const</span> <span class="keyword">char</span> *name, RedisModuleCmdFunc cmdfunc, <span class="keyword">const</span> <span class="keyword">char</span> *strflags, <span class="keyword">int</span> firstkey, <span class="keyword">int</span> lastkey, <span class="keyword">int</span> keystep)</span> </span>&#123;</div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">redisCommand</span> *<span class="title">rediscmd</span>;</span></div><div class="line">    RedisModuleCommandProxy *cp;</div><div class="line">    ...</div><div class="line">    <span class="comment">// 忽略次要的代码路径</span></div><div class="line"></div><div class="line">    cp = zmalloc(<span class="keyword">sizeof</span>(*cp));</div><div class="line">    cp-&gt;<span class="keyword">module</span> = ctx-&gt;<span class="keyword">module</span>;</div><div class="line">    <span class="comment">// 真正的处理函数</span></div><div class="line">    cp-&gt;func = cmdfunc;</div><div class="line">    cp-&gt;rediscmd = zmalloc(<span class="keyword">sizeof</span>(*rediscmd));</div><div class="line">    cp-&gt;rediscmd-&gt;name = cmdname;</div><div class="line">    <span class="comment">// 命令处理函数设置为 RedisModuleCommandDispatcher</span></div><div class="line">    cp-&gt;rediscmd-&gt;proc = RedisModuleCommandDispatcher;</div><div class="line">    cp-&gt;rediscmd-&gt;arity = <span class="number">-1</span>;</div><div class="line">    cp-&gt;rediscmd-&gt;flags = flags | CMD_MODULE;</div><div class="line">    cp-&gt;rediscmd-&gt;getkeys_proc = (redisGetKeysProc*)(<span class="keyword">unsigned</span> <span class="keyword">long</span>)cp;</div><div class="line">    cp-&gt;rediscmd-&gt;firstkey = firstkey;</div><div class="line">    cp-&gt;rediscmd-&gt;lastkey = lastkey;</div><div class="line">    cp-&gt;rediscmd-&gt;keystep = keystep;</div><div class="line">    cp-&gt;rediscmd-&gt;microseconds = <span class="number">0</span>;</div><div class="line">    cp-&gt;rediscmd-&gt;calls = <span class="number">0</span>;</div><div class="line">    dictAdd(server.commands,sdsdup(cmdname),cp-&gt;rediscmd);</div><div class="line">    dictAdd(server.orig_commands,sdsdup(cmdname),cp-&gt;rediscmd);</div><div class="line">    <span class="keyword">return</span> REDISMODULE_OK;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">RedisModuleCommandDispatcher</span><span class="params">(client *c)</span> </span>&#123;</div><div class="line">    RedisModuleCommandProxy *cp = (<span class="keyword">void</span>*)(<span class="keyword">unsigned</span> <span class="keyword">long</span>)c-&gt;cmd-&gt;getkeys_proc;</div><div class="line">    RedisModuleCtx ctx = REDISMODULE_CTX_INIT;</div><div class="line"></div><div class="line">    ctx.<span class="keyword">module</span> = cp-&gt;<span class="keyword">module</span>;</div><div class="line">    ctx.client = c;</div><div class="line">    <span class="comment">// 调用真正的处理函数</span></div><div class="line">    cp-&gt;func(&amp;ctx,(<span class="keyword">void</span>**)c-&gt;argv,c-&gt;argc);</div><div class="line">    moduleHandlePropagationAfterCommandCallback(&amp;ctx);</div><div class="line">    moduleFreeContext(&amp;ctx);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>值得一提的是，在模块中调用的函数是 RedisModule_CreateCommand，而上述的函数是 RM<em>CreateCommand。这是因为 Redis 做了一层重命名，内部实现是 RM</em> 开头，而对外暴露的时候使用 RedisModule_ 开头，具体的转化在 RedisModule_Init 里完成。</p>
<h3 id="自定义数据结构"><a href="#自定义数据结构" class="headerlink" title="自定义数据结构"></a>自定义数据结构</h3><p>创建一个新的数据结构时，需要定义好几个回调函数。Redis 并不关心外部的数据是如何操作的，只需要关心数据要怎么来进行持久化以及释放，具体的操作由命令决定。例子如下：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">RedisModule_OnLoad</span><span class="params">(RedisModuleCtx *ctx, RedisModuleString **argv, <span class="keyword">int</span> argc)</span> </span>&#123;</div><div class="line">    REDISMODULE_NOT_USED(argv);</div><div class="line">    REDISMODULE_NOT_USED(argc);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (RedisModule_Init(ctx,<span class="string">"hellotype"</span>,<span class="number">1</span>,REDISMODULE_APIVER_1)</div><div class="line">        == REDISMODULE_ERR) <span class="keyword">return</span> REDISMODULE_ERR;</div><div class="line"></div><div class="line">    RedisModuleTypeMethods tm = &#123;</div><div class="line">        .version = REDISMODULE_TYPE_METHOD_VERSION,</div><div class="line">        .rdb_load = HelloTypeRdbLoad,</div><div class="line">        .rdb_save = HelloTypeRdbSave,</div><div class="line">        .aof_rewrite = HelloTypeAofRewrite,</div><div class="line">        .<span class="built_in">free</span> = HelloTypeFree</div><div class="line">    &#125;;</div><div class="line">    HelloType = RedisModule_CreateDataType(ctx,<span class="string">"hellotype"</span>,<span class="number">0</span>,&amp;tm);</div><div class="line">    <span class="keyword">if</span> (HelloType == <span class="literal">NULL</span>) <span class="keyword">return</span> REDISMODULE_ERR</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="已有模块"><a href="#已有模块" class="headerlink" title="已有模块"></a>已有模块</h3><p>目前已经有人使用这个功能开发了各种各样的模块， 比如 Redis Labs 开发的一些模块就可以在 <a href="http://redismodules.com" target="_blank" rel="external">http://redismodules.com</a> 看到， 此外 antirez 自己也使用这个功能开发了一个神经网络模块： <a href="https://github.com/antirez/neural-redis" target="_blank" rel="external">https://github.com/antirez/neural-redis</a></p>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><ul>
<li><a href="http://antirez.com/news/106" target="_blank" rel="external">Redis Loadable Modules System</a></li>
<li><a href="https://redis.io/topics/modules-intro" target="_blank" rel="external">Redis Modules: an introduction to the API</a></li>
<li><a href="https://redis.io/topics/modules-api-ref" target="_blank" rel="external">Modules API reference</a></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/07/29/redis_4_new_features/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="柿子">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="柿子的果盘">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/29/redis_4_new_features/" itemprop="url">Redis 4.0 新功能</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-29T00:00:00+08:00">
                2017-07-29
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/开源项目/" itemprop="url" rel="index">
                    <span itemprop="name">开源项目</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/07/29/redis_4_new_features/#comments" itemprop="discussionUrl">
                  评论数 <span class="post-comments-count fb-comments-count" data-href="http://yoursite.com/2017/07/29/redis_4_new_features/" itemprop="commentCount">0</span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/07/29/redis_4_new_features/" class="leancloud_visitors" data-flag-title="Redis 4.0 新功能">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="模块系统"><a href="#模块系统" class="headerlink" title="模块系统"></a>模块系统</h3><p>Redis 4.0 发生的最大的变化就是加入模块系统，这个系统可以让用户通过自己编写的代码来拓展和实现 Redis 本身并不具备的功能。<br>关于加入模块系统的动机，具体可以参考 antirez 写的博客：<a href="http://antirez.com/news/106" target="_blank" rel="external">Redis Loadable Modules System</a><br>从使用的角度来讲，主要需要知道如何加载模块，以及有哪一些模块可用：</p>
<ul>
<li>静态加载方式：loadmodule /path/to/mymodule.so</li>
<li>动态加载方式：MODULE LOAD /path/to/mymodule.so</li>
<li>已经编写好的一些模块：<a href="https://redis.io/modules" target="_blank" rel="external">https://redis.io/modules</a><br>至于如何编写模块等更多细节的内容具体可以参考：<a href="https://redis.io/topics/modules-intro" target="_blank" rel="external">https://redis.io/topics/modules-intro</a></li>
</ul>
<h3 id="PSYNC-优化"><a href="#PSYNC-优化" class="headerlink" title="PSYNC 优化"></a>PSYNC 优化</h3><p>新版本的 PSYNC 命令解决了如下两个场景需要全量复制的问题：</p>
<ul>
<li>如果一个从服务器在 FAILOVER 之后成为了新的主节点， 那么其他从节点在复制这个新主的时候就必须进行全量复制</li>
<li>一个从服务器如果重启了， 那么它就必须与主服务器重新进行全量复制<br>在 Redis 4.0 中，在其它条件（主要是复制偏移量满足条件）具备的情况下，允许进行增量复制，而不需要进行全量复制。</li>
</ul>
<h3 id="非阻塞删除"><a href="#非阻塞删除" class="headerlink" title="非阻塞删除"></a>非阻塞删除</h3><p>在 Redis 4.0 之前， 用户在使用 DEL 命令删除体积较大的键， 又或者在使用 FLUSHDB 和 FLUSHALL 删除包含大量键的数据库时， 都可能会造成服务器阻塞。<br>为了解决以上问题， Redis 4.0 新添加了 UNLINK 命令， 这个命令是 DEL 命令的异步版本， 它可以将删除指定键的操作放在后台线程里面执行， 从而尽可能地避免服务器阻塞：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">redis&gt; UNLINK fruits</div><div class="line">(<span class="built_in">integer</span>) 1</div></pre></td></tr></table></figure></p>
<p>此外， Redis 4.0 中的 FLUSHDB 和 FLUSHALL 这两个命令都新添加了 ASYNC 选项， 带有这个选项的数据库删除操作将在后台线程进行：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">redis&gt; FLUSHDB ASYNC</div><div class="line">OK</div><div class="line"></div><div class="line">redis&gt; FLUSHALL ASYNC</div><div class="line">OK</div></pre></td></tr></table></figure></p>
<h3 id="混合持久化"><a href="#混合持久化" class="headerlink" title="混合持久化"></a>混合持久化</h3><p>Redis 4.0 新增了 RDB-AOF 混合持久化格式， 这是一个可选的功能， 在开启了这个功能之后， AOF 重写产生的文件将同时包含 RDB 格式的内容和 AOF 格式的内容， 其中 RDB 格式的内容用于记录已有的数据， 而 AOF 格式的内存则用于记录最近发生了变化的数据， 这样 Redis 就可以同时兼有 RDB 持久化和 AOF 持久化的优点 —— 既能够快速地生成重写文件， 也能够在出现问题时， 快速地载入数据。这个功能可以通过 aof-use-rdb-preamble 选项进行开启。</p>
<h3 id="LFU-数据淘汰策略"><a href="#LFU-数据淘汰策略" class="headerlink" title="LFU 数据淘汰策略"></a>LFU 数据淘汰策略</h3><p>Redis 4.0 对数据淘汰策略进行了两项调整：</p>
<ul>
<li>增加了 LFU（Last Frequently Used）淘汰策略</li>
<li>在使用多个 Redis 作为缓存的场景下，使用一个采样池进行淘汰，而非一个数据库一个采样池，避免了某些数据库中都是新数据，而另外一些数据库中都是老数据的情况</li>
</ul>
<h3 id="交换数据库"><a href="#交换数据库" class="headerlink" title="交换数据库"></a>交换数据库</h3><p>Redis 4.0 对数据库命令的另外一个修改是新增了 SWAPDB 命令， 这个命令可以对指定的两个数据库进行互换： 比如说， 通过执行命令 SWAPDB 0 1 ， 我们可以将原来的数据库 0 变成数据库 1 ， 而原来的数据库 1 则变成数据库 0 。<br>内存命令<br>新添加了一个 MEMORY 命令， 这个命令可以用于视察内存使用情况， 并进行相应的内存管理操作：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">redis&gt; MEMORY HELP</div><div class="line">1) <span class="string">"MEMORY USAGE &lt;key&gt; [SAMPLES &lt;count&gt;] - Estimate memory usage of key"</span></div><div class="line">2) <span class="string">"MEMORY STATS                         - Show memory usage details"</span></div><div class="line">3) <span class="string">"MEMORY PURGE                         - Ask the allocator to release memory"</span></div><div class="line">4) <span class="string">"MEMORY MALLOC-STATS                  - Show allocator internal stats"</span></div></pre></td></tr></table></figure></p>
<ul>
<li>MEMORYUSAGE 命令可以估算储存给定键所需的内存</li>
<li>MEMORYSTATS 命令可以查看 Redis 当前的内存使用情况</li>
<li>MEMORYPURGE 命令可以要求分配器释放更多内存</li>
<li>MEMORYMALLOC-STATS 命令可以展示分配器内部状态</li>
</ul>
<h3 id="兼容-NAT-和-Docker"><a href="#兼容-NAT-和-Docker" class="headerlink" title="兼容 NAT 和 Docker"></a>兼容 NAT 和 Docker</h3><p>Redis 4.0 将兼容 NAT 和 Docker ， 在这种模式下，需要显式指定 Redis 的公网 ip 和 端口。配置例如：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># cluster-announce-ip 10.1.1.5</span></div><div class="line"><span class="comment"># cluster-announce-port 6379</span></div><div class="line"><span class="comment"># cluster-announce-bus-port 6380</span></div></pre></td></tr></table></figure></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/07/22/redis_lock/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="柿子">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="柿子的果盘">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/22/redis_lock/" itemprop="url">使用 Redis 实现分布式锁</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-22T00:00:00+08:00">
                2017-07-22
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/网站开发/" itemprop="url" rel="index">
                    <span itemprop="name">网站开发</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/07/22/redis_lock/#comments" itemprop="discussionUrl">
                  评论数 <span class="post-comments-count fb-comments-count" data-href="http://yoursite.com/2017/07/22/redis_lock/" itemprop="commentCount">0</span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/07/22/redis_lock/" class="leancloud_visitors" data-flag-title="使用 Redis 实现分布式锁">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="SETNX-命令"><a href="#SETNX-命令" class="headerlink" title="SETNX 命令"></a>SETNX 命令</h4><p>参考 Redis 的<a href="http://redisdoc.com/string/setnx.html" target="_blank" rel="external">命令手册</a>，相关说明如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">SETNX key value</div><div class="line"></div><div class="line">将 key 的值设为 value ，当且仅当 key 不存在。</div><div class="line">若给定的 key 已经存在，则 SETNX 不做任何动作。</div><div class="line">SETNX 是『SET if Not eXists』(如果不存在，则 SET)的简写。</div><div class="line"></div><div class="line">可用版本：</div><div class="line">&gt;= 1.0.0</div><div class="line">时间复杂度：</div><div class="line">O(1)</div><div class="line">返回值：</div><div class="line">设置成功，返回 1 。</div><div class="line">设置失败，返回 0 。</div></pre></td></tr></table></figure></p>
<h4 id="简单实现"><a href="#简单实现" class="headerlink" title="简单实现"></a>简单实现</h4><p>一个简单的想法是，执行命令 SETNX lock_name (current_time + lock_time)：</p>
<ul>
<li>若返回 1，则设置成功，获得这个锁；</li>
<li>若返回 0，则等待或者直接返回失败。</li>
</ul>
<h4 id="多个进程获得同一个锁"><a href="#多个进程获得同一个锁" class="headerlink" title="多个进程获得同一个锁"></a>多个进程获得同一个锁</h4><p>如果按照上述的实现方式，如果没有很好地实现锁的释放机制，则很有可能导致死锁的情况，具体的例子如下：</p>
<ul>
<li>P1 获得 lock_name 对应的锁</li>
<li>P1 断开连接，没有正常释放锁</li>
<li>P2 和 P3 同时发现锁已经超时</li>
<li>P2 执行 DEL lock_name 删除锁</li>
<li>P2 执行 SETNX lock_name 获得锁</li>
<li>P3 执行 DEL lock_name 将 P2 刚刚设置的键 lock_name 删除</li>
<li>P3 执行 SETNX lock_name 获得锁</li>
</ul>
<p>在这种情况下，由于 P3 在 P2 获得锁前检测到了锁超时，因此执行了 DEL 命令，将 P2 后来设置的超时删除。而 P2 和 P3 同时获得了锁。</p>
<h4 id="GETSET-命令"><a href="#GETSET-命令" class="headerlink" title="GETSET 命令"></a>GETSET 命令</h4><p>参考 Redis 的<a href="http://redisdoc.com/string/getset.html" target="_blank" rel="external">命令手册</a>，相关说明如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">GETSET key value</div><div class="line">将给定 key 的值设为 value ，并返回 key 的旧值(old value)。</div><div class="line">当 key 存在但不是字符串类型时，返回一个错误。</div><div class="line"></div><div class="line">可用版本：</div><div class="line">&gt;= 1.0.0</div><div class="line">时间复杂度：</div><div class="line">O(1)</div><div class="line">返回值：</div><div class="line">返回给定 key 的旧值。</div><div class="line">当 key 没有旧值时，也即是， key 不存在时，返回 nil 。</div></pre></td></tr></table></figure></p>
<h4 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h4><p>我们需要替换对锁超时的情况的处理，按时间先后顺序如下：</p>
<ul>
<li>P1 获得 lock_name 对应的锁</li>
<li>P1 断开连接，没有正常释放锁</li>
<li>P2 和 P3 同时发现锁已经超时</li>
<li>P2 执行 GETSET lock_name (current_time + lock_time)</li>
<li>P3 执行 GETSET lock_name (current_time + lock_time)</li>
<li>P3 获取返回结果，lock_name 对应的旧值小于检测时间，说明设置成功，获得锁</li>
<li>P2 获取返回结果，lock_name 对应的旧值是 P3 设置的结果，大于检测时间，说明已有其它线程获得锁，P2 获取失败</li>
</ul>
<p>利用 GETSET 返回旧值的特性，可以在检测到超时的时候，执行 GETSET 设置新的超时时间，即使有多个进程同时执行 GETSET，最终也只会有一个判定设置成功，从而获得锁。</p>
<h4 id="Python-实现"><a href="#Python-实现" class="headerlink" title="Python 实现"></a>Python 实现</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Lock</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="string">"""</span></div><div class="line">    A shared, distributed Lock. Using Redis for locking allows the Lock</div><div class="line">    to be shared across processes and/or machines.</div><div class="line"></div><div class="line">    It's left to the user to resolve deadlock issues and make sure</div><div class="line">    multiple clients play nicely together.</div><div class="line">    """</div><div class="line"></div><div class="line">    LOCK_FOREVER = float(<span class="number">2</span> ** <span class="number">31</span> + <span class="number">1</span>)  <span class="comment"># 1 past max unix time</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, redis, name, timeout=None, sleep=<span class="number">0.1</span>)</span>:</span></div><div class="line">        <span class="string">"""</span></div><div class="line">        Create a new Lock instnace named ``name`` using the Redis client</div><div class="line">        supplied by ``redis``.</div><div class="line"></div><div class="line">        ``timeout`` indicates a maximum life for the lock.</div><div class="line">        By default, it will remain locked until release() is called.</div><div class="line"></div><div class="line">        ``sleep`` indicates the amount of time to sleep per loop iteration</div><div class="line">        when the lock is in blocking mode and another client is currently</div><div class="line">        holding the lock.</div><div class="line"></div><div class="line">        Note: If using ``timeout``, you should make sure all the hosts</div><div class="line">        that are running clients have their time synchronized with a network</div><div class="line">        time service like ntp.</div><div class="line">        """</div><div class="line">        self.redis = redis</div><div class="line">        self.name = name</div><div class="line">        self.acquired_until = <span class="keyword">None</span></div><div class="line">        self.timeout = timeout</div><div class="line">        self.sleep = sleep</div><div class="line">        <span class="keyword">if</span> self.timeout <span class="keyword">and</span> self.sleep &gt; self.timeout:</div><div class="line">            <span class="keyword">raise</span> LockError(<span class="string">"'sleep' must be less than 'timeout'"</span>)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__enter__</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> self.acquire()</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__exit__</span><span class="params">(self, exc_type, exc_value, traceback)</span>:</span></div><div class="line">        self.release()</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">acquire</span><span class="params">(self, blocking=True)</span>:</span></div><div class="line">        <span class="string">"""</span></div><div class="line">        Use Redis to hold a shared, distributed lock named ``name``.</div><div class="line">        Returns True once the lock is acquired.</div><div class="line"></div><div class="line">        If ``blocking`` is False, always return immediately. If the lock</div><div class="line">        was acquired, return True, otherwise return False.</div><div class="line">        """</div><div class="line">        sleep = self.sleep</div><div class="line">        timeout = self.timeout</div><div class="line">        <span class="keyword">while</span> <span class="number">1</span>:</div><div class="line">            unixtime = mod_time.time()</div><div class="line">            <span class="keyword">if</span> timeout:</div><div class="line">                timeout_at = unixtime + timeout</div><div class="line">            <span class="keyword">else</span>:</div><div class="line">                timeout_at = Lock.LOCK_FOREVER</div><div class="line">            timeout_at = float(timeout_at)</div><div class="line">            <span class="keyword">if</span> self.redis.setnx(self.name, timeout_at):</div><div class="line">                self.acquired_until = timeout_at</div><div class="line">                <span class="keyword">return</span> <span class="keyword">True</span></div><div class="line">            <span class="comment"># We want blocking, but didn't acquire the lock</span></div><div class="line">            <span class="comment"># check to see if the current lock is expired</span></div><div class="line">            existing = float(self.redis.get(self.name) <span class="keyword">or</span> <span class="number">1</span>)</div><div class="line">            <span class="keyword">if</span> existing &lt; unixtime:</div><div class="line">                <span class="comment"># the previous lock is expired, attempt to overwrite it</span></div><div class="line">                existing = float(self.redis.getset(self.name, timeout_at) <span class="keyword">or</span> <span class="number">1</span>)</div><div class="line">                <span class="keyword">if</span> existing &lt; unixtime:</div><div class="line">                    <span class="comment"># we successfully acquired the lock</span></div><div class="line">                    self.acquired_until = timeout_at</div><div class="line">                    <span class="keyword">return</span> <span class="keyword">True</span></div><div class="line">            <span class="keyword">if</span> <span class="keyword">not</span> blocking:</div><div class="line">                <span class="keyword">return</span> <span class="keyword">False</span></div><div class="line">            mod_time.sleep(sleep)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">release</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="string">"Releases the already acquired lock"</span></div><div class="line">        <span class="keyword">if</span> self.acquired_until <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">            <span class="keyword">raise</span> ValueError(<span class="string">"Cannot release an unlocked lock"</span>)</div><div class="line">        existing = float(self.redis.get(self.name) <span class="keyword">or</span> <span class="number">1</span>)</div><div class="line">        <span class="comment"># if the lock time is in the future, delete the lock</span></div><div class="line">        delete_lock = existing &gt;= self.acquired_until</div><div class="line">        self.acquired_until = <span class="keyword">None</span></div><div class="line">        <span class="keyword">if</span> delete_lock:</div><div class="line">            self.redis.delete(self.name)</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/07/18/restful_design/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="柿子">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="柿子的果盘">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/18/restful_design/" itemprop="url">理解 RESTful</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-18T00:00:00+08:00">
                2017-07-18
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/网站开发/" itemprop="url" rel="index">
                    <span itemprop="name">网站开发</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/07/18/restful_design/#comments" itemprop="discussionUrl">
                  评论数 <span class="post-comments-count fb-comments-count" data-href="http://yoursite.com/2017/07/18/restful_design/" itemprop="commentCount">0</span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/07/18/restful_design/" class="leancloud_visitors" data-flag-title="理解 RESTful">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="什么是-RESTful"><a href="#什么是-RESTful" class="headerlink" title="什么是 RESTful"></a>什么是 RESTful</h3><p>REST 是 Representation State Transfer 的缩写，具体的含义是“资源表现层的状态转化”。如果一个架构符合 REST 原则，那么它就被称为 RESTful 的。要理解 REST 原则，我们需要理解如下的一些概念。</p>
<h4 id="资源及其表现"><a href="#资源及其表现" class="headerlink" title="资源及其表现"></a>资源及其表现</h4><p>对于网络上的信息，例如一段文本，一个网页，一张图片，或一段音乐，都可以被称为资源。它们在网络上由一个具体的 URI 进行指向。当我们需要获取这个字段时，访问对应的 URI 就可以了。<br>而资源是一种信息实体，它会有很多具体的表现形式，例如 HTML 格式、JSON 格式等。URI只代表资源的实体，而最后例如“.html”等后缀名则是这个资源的具体表现形式。</p>
<h4 id="状态转化"><a href="#状态转化" class="headerlink" title="状态转化"></a>状态转化</h4><p>访问一个网站，就代表了客户端和服务器的一个互动过程。在这个过程中，会涉及到数据和状态的变化。而 HTTP 协议，是一个无状态协议。这意味着，所有的状态都保存在服务器端。因此，如果客户端想要操作服务器，必须通过某种手段，让服务器端发生“状态转化”。而这种转化是建立在资源的表现层上的，所以就是“资源表现层状的态转化”。</p>
<h3 id="实践原则"><a href="#实践原则" class="headerlink" title="实践原则"></a>实践原则</h3><p>在具体使用 RESTful 架构的时候，如下的原则通常是一种比较好的实践方式：</p>
<ul>
<li>URI 表示的是一种资源，而不是一个动作，因此避免使用动词；</li>
<li>在 HTTP 请求的 header 中用 Accept 和 Content-Type 来指定资源的表现形式，而不是通过后缀；</li>
<li>对资源的操作使用 HTTP 协议中定义的基本操作来进行：GET 获取资源，POST 新建资源或更新资源，PUT 更新资源，DELETE 删除资源。</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/07/16/python_global_variable_import/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="柿子">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="柿子的果盘">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/16/python_global_variable_import/" itemprop="url">Python 共享变量</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-16T00:00:00+08:00">
                2017-07-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/开发语言/" itemprop="url" rel="index">
                    <span itemprop="name">开发语言</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/07/16/python_global_variable_import/#comments" itemprop="discussionUrl">
                  评论数 <span class="post-comments-count fb-comments-count" data-href="http://yoursite.com/2017/07/16/python_global_variable_import/" itemprop="commentCount">0</span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/07/16/python_global_variable_import/" class="leancloud_visitors" data-flag-title="Python 共享变量">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>今天开发的时候碰到一个坑，在一个数据库模块中定义了一个 Redis 的连接，初始化以后，在具体的业务模块中获取 Redis 连接怎么都是 None。经过排查，发现自己对于 Python 的多模块共享变量的 import 机制缺乏了解，于是查阅资料，做个总结。</p>
<h3 id="碰到的问题"><a href="#碰到的问题" class="headerlink" title="碰到的问题"></a>碰到的问题</h3><p>简化以后的伪代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># redis.py</span></div><div class="line"></div><div class="line">redis_conn = <span class="keyword">None</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">config_redis_conn</span><span class="params">(conf)</span>:</span></div><div class="line">    redis_conn = init_new_redis(conf)</div></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># bootstrap.py</span></div><div class="line"></div><div class="line"><span class="keyword">from</span> redis <span class="keyword">import</span> config_redis_conn</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    config_redis_conn(&#123;&#125;)</div></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># business_logic.py</span></div><div class="line"><span class="keyword">from</span> redis <span class="keyword">import</span> redis_conn</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">logic</span><span class="params">()</span>:</span></div><div class="line">    redis_conn.set(<span class="string">'A'</span>, <span class="string">'B'</span>)</div></pre></td></tr></table></figure>
<p>在 business_logic 使用 redis_conn 的时候，会发现 redis_conn 是 None，即使已经经过 bootstrap 的初始化。</p>
<h3 id="Python-的-import-机制"><a href="#Python-的-import-机制" class="headerlink" title="Python 的 import 机制"></a>Python 的 import 机制</h3><p>Python import 包的机制是：import 进来的模块和默认的系统模块，都放在 sys.module 这个字典里面。当模块再次 import 的时候，会先去 sys.module 里面检查是否已经 import 了，如果已经 import 了，就不再重复 import，否则就 import 进来。<br>from redis import redis_conn 这样的方式引用，就相当于在 business_logic.py 文件中写了一行代码 redis_conn = None，此时 redis_conn 就是 business_logic.py 自己命名空间中的变量。所以 redis_conn 只在 business_logic.py 中有效，因此即使在 bootstrap.py 中初始化了 redis_conn，business_logic.py 中的 redis_conn 依旧没有改变。换种说法，实际上<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> redis <span class="keyword">import</span> redis_conn</div></pre></td></tr></table></figure></p>
<p>等同于<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">improt redis</div><div class="line">redis_conn = redis.redis_conn</div></pre></td></tr></table></figure></p>
<p>所以，如果需要共享变量，就不要使用 from file import x 这种形式，而是使用 import file，然后就可以通过 file.x 来使用，然后 file.x=’abc’ 进行修改。这样都这样处理全局性的变量就可以共享的。也就是保持一个独立的namespace，这样python不会再次导入，从而实现共享。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/07/01/thrift_introduction/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="柿子">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="柿子的果盘">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/01/thrift_introduction/" itemprop="url">Thrift 入门篇</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-01T00:00:00+08:00">
                2017-07-01
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/开源项目/" itemprop="url" rel="index">
                    <span itemprop="name">开源项目</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/07/01/thrift_introduction/#comments" itemprop="discussionUrl">
                  评论数 <span class="post-comments-count fb-comments-count" data-href="http://yoursite.com/2017/07/01/thrift_introduction/" itemprop="commentCount">0</span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/07/01/thrift_introduction/" class="leancloud_visitors" data-flag-title="Thrift 入门篇">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>Apache Thrift 是由 Facebook 开发的远程服务调用框架，它采用接口描述语言（IDL）定义并创建服务，支持可扩展的跨语言服务开发，所包含的代码生成引擎可以在多种语言中，如 C++, Java, Python, PHP, Ruby, Erlang, Perl, Haskell, C#, Cocoa, Smalltalk 等创建高效的、无缝的服务，其传输数据采用二进制格式，相对 XML 和 JSON 体积更小，对于高并发、大数据量和多语言的环境更有优势。</p>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><ul>
<li>下载 <a href="http://www.boost.org/" target="_blank" rel="external">boost</a> 并安装：</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">./bootstrap.sh</div><div class="line">sudo ./b2 threading=multi address-model=64 variant=release stage install</div></pre></td></tr></table></figure>
<ul>
<li>下载 <a href="http://libevent.org/" target="_blank" rel="external">libevent</a> 并安装：</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">./configure --prefix=/usr/<span class="built_in">local</span></div><div class="line">make</div><div class="line">sudo make install</div></pre></td></tr></table></figure>
<p>在执行 make 的时候可能会碰到一个问题：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">/Library/Developer/CommandLineTools/usr/bin/make  all-am</div><div class="line">  CC       libevent_openssl_la-bufferevent_openssl.lo</div><div class="line">bufferevent_openssl.c:66:10: fatal error: <span class="string">'openssl/bio.h'</span> file not found</div><div class="line"><span class="comment">#include &lt;openssl/bio.h&gt;</span></div><div class="line">         ^</div><div class="line">1 error generated.</div><div class="line">make[1]: *** [libevent_openssl_la-bufferevent_openssl.lo] Error 1</div><div class="line">make: *** [all] Error 2</div></pre></td></tr></table></figure></p>
<p>我的解决方案是执行如下命令：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./configure LDFLAGS=<span class="string">'-L/usr/local/opt/openssl/lib'</span> CPPFLAGS=<span class="string">'-I/usr/local/opt/openssl/include'</span></div></pre></td></tr></table></figure></p>
<ul>
<li>下载 Thrift 并编译</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">./configure --prefix=/usr/<span class="built_in">local</span>/ --with-boost=/usr/<span class="built_in">local</span> --with-libevent=/usr/<span class="built_in">local</span></div><div class="line">make</div><div class="line">sudo make install</div></pre></td></tr></table></figure>
<p>  这边可能会碰到一个问题，就是 mac 中默认安装了 bison 2.3 版本，并配置了路径在 path 中。<br>  需要安装最新的版本 3.0.4, 并将 /usr/bin 中的 bison 删除，将bison 3.0.4 复制到 /usr/bin 中：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">brew install bison</div><div class="line"><span class="built_in">cd</span> /usr/bin</div><div class="line">sudo mv bison bison.2.3</div><div class="line">sudo cp /usr/<span class="built_in">local</span>/Cellar/bison/3.0.4/bin/bison bxison</div></pre></td></tr></table></figure></p>
<p>  如果安装了 Xcode，那有可能是 Xcode 自带的 bison。<br>  将 Xcode 的 bison 改名后编译，编译完以后再把名字改回来。<br>  路径：/Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/<br>  此外，如果不需要其它语言的话，可以用 “–without” 选项将其排除，例如 “–without-perl”，否则可能因为本地环境配置的问题导致编译失败。</p>
<h3 id="一个简单的例子"><a href="#一个简单的例子" class="headerlink" title="一个简单的例子"></a>一个简单的例子</h3><h4 id="例子的文件结构"><a href="#例子的文件结构" class="headerlink" title="例子的文件结构"></a>例子的文件结构</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">├── client.py</div><div class="line">├── gen-py</div><div class="line">│   ├── __init__.py</div><div class="line">│   └── helloworld</div><div class="line">│       ├── HelloWorld-remote</div><div class="line">│       ├── HelloWorld.py</div><div class="line">│       ├── __init__.py</div><div class="line">│       ├── constants.py</div><div class="line">│       └── ttypes.py</div><div class="line">├── helloworld.thrift</div><div class="line">└── server.py</div></pre></td></tr></table></figure>
<h4 id="定义-helloword-thrift-文件"><a href="#定义-helloword-thrift-文件" class="headerlink" title="定义 helloword.thrift 文件"></a>定义 helloword.thrift 文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">service HelloWorld &#123;</div><div class="line">  string ping(),</div><div class="line">  string say(1:string msg)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="自动生成代码"><a href="#自动生成代码" class="headerlink" title="自动生成代码"></a>自动生成代码</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">thrift --gen py helloword.thrift</div></pre></td></tr></table></figure>
<h4 id="生成-server-端的代码"><a href="#生成-server-端的代码" class="headerlink" title="生成 server 端的代码"></a>生成 server 端的代码</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python</span></div><div class="line"></div><div class="line"><span class="keyword">import</span> socket</div><div class="line"><span class="keyword">import</span> sys</div><div class="line"></div><div class="line">sys.path.append(<span class="string">'./gen-py'</span>)</div><div class="line"><span class="keyword">from</span> helloworld <span class="keyword">import</span> HelloWorld</div><div class="line"><span class="keyword">from</span> helloworld.ttypes <span class="keyword">import</span> *</div><div class="line"><span class="keyword">from</span> thrift.transport <span class="keyword">import</span> TSocket</div><div class="line"><span class="keyword">from</span> thrift.transport <span class="keyword">import</span> TTransport</div><div class="line"><span class="keyword">from</span> thrift.protocol <span class="keyword">import</span> TBinaryProtocol</div><div class="line"><span class="keyword">from</span> thrift.server <span class="keyword">import</span> TServer</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">HelloWorldHandler</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">ping</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> <span class="string">"pong"</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">say</span><span class="params">(self, msg)</span>:</span></div><div class="line">        ret = <span class="string">"Received: "</span> + msg</div><div class="line">        <span class="keyword">print</span> ret</div><div class="line">        <span class="keyword">return</span> ret</div></pre></td></tr></table></figure>
<h4 id="加入启动服务的代码"><a href="#加入启动服务的代码" class="headerlink" title="加入启动服务的代码"></a>加入启动服务的代码</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">handler = HelloWorldHandler()</div><div class="line">processor = HelloWorld.Processor(handler)</div><div class="line">transport = TSocket.TServerSocket(<span class="string">"localhost"</span>, <span class="number">9090</span>)</div><div class="line">tfactory = TTransport.TBufferedTransportFactory()</div><div class="line">pfactory = TBinaryProtocol.TBinaryProtocolFactory()</div><div class="line">server = TServer.TSimpleServer(processor, transport, tfactory, pfactory)</div><div class="line"><span class="keyword">print</span> <span class="string">"Starting thrift server in python..."</span></div><div class="line">server.serve()</div><div class="line"><span class="keyword">print</span> <span class="string">"done!"</span></div></pre></td></tr></table></figure>
<h4 id="生成-client-端的代码"><a href="#生成-client-端的代码" class="headerlink" title="生成 client 端的代码"></a>生成 client 端的代码</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python</span></div><div class="line"></div><div class="line"><span class="keyword">import</span> sys</div><div class="line"></div><div class="line">sys.path.append(<span class="string">'./gen-py'</span>)</div><div class="line"><span class="keyword">from</span> helloworld <span class="keyword">import</span> HelloWorld</div><div class="line"><span class="keyword">from</span> thrift <span class="keyword">import</span> Thrift</div><div class="line"><span class="keyword">from</span> thrift.transport <span class="keyword">import</span> TSocket</div><div class="line"><span class="keyword">from</span> thrift.transport <span class="keyword">import</span> TTransport</div><div class="line"><span class="keyword">from</span> thrift.protocol <span class="keyword">import</span> TBinaryProtocol</div><div class="line"></div><div class="line"><span class="keyword">try</span>:</div><div class="line">    transport = TSocket.TSocket(<span class="string">'localhost'</span>, <span class="number">9090</span>)</div><div class="line">    transport = TTransport.TBufferedTransport(transport)</div><div class="line">    protocol = TBinaryProtocol.TBinaryProtocol(transport)</div><div class="line">    client = HelloWorld.Client(protocol)</div><div class="line">    transport.open()</div><div class="line"></div><div class="line">    <span class="keyword">print</span> <span class="string">"client - ping"</span></div><div class="line">    <span class="keyword">print</span> <span class="string">"server - "</span> + client.ping()</div><div class="line">    <span class="keyword">print</span> <span class="string">"client - say"</span></div><div class="line">    msg = client.say(<span class="string">"Hello!"</span>)</div><div class="line">    <span class="keyword">print</span> <span class="string">"server - "</span> + msg</div><div class="line"></div><div class="line">    transport.close()</div><div class="line"><span class="keyword">except</span> Thrift.TException, ex:</div><div class="line">    <span class="keyword">print</span> <span class="string">"%s"</span> % (ex.message)</div></pre></td></tr></table></figure>
<h4 id="运行代码"><a href="#运行代码" class="headerlink" title="运行代码"></a>运行代码</h4><p>运行 server 端代码和 client 端代码，可以在 server 端看到如下日志：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Starting thrift server <span class="keyword">in</span> python...</div><div class="line">Received: Hello!</div></pre></td></tr></table></figure></p>
<p>在 client 端看到如下日志：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">client - ping</div><div class="line">server - pong</div><div class="line">client - say</div><div class="line">server - Received: Hello!</div></pre></td></tr></table></figure></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.jpg"
               alt="柿子" />
          <p class="site-author-name" itemprop="name">柿子</p>
           
              <p class="site-description motion-element" itemprop="description">一个非主流程序员</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">26</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">5</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">7</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">柿子</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.1"></script>



  
    <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  




	





  





  





  






  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("m5cJ6uWE1c1GaX65w4A1DubN-gzGzoHsz", "kI8J0OH8eDBG6WdG10XRj37j");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  

  

  

</body>
</html>
