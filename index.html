<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta name="description" content="一个非主流程序员">
<meta property="og:type" content="website">
<meta property="og:title" content="柿子的果盘">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="柿子的果盘">
<meta property="og:description" content="一个非主流程序员">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="柿子的果盘">
<meta name="twitter:description" content="一个非主流程序员">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title>柿子的果盘</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?30798a6e72702e12c529efb9326dc7e1";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>










</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">柿子的果盘</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">随手记录一些所读、所思、所感</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/07/18/restful_design/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="柿子">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="柿子的果盘">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/18/restful_design/" itemprop="url">理解 RESTful</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-18T00:00:00+08:00">
                2017-07-18
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/架构/" itemprop="url" rel="index">
                    <span itemprop="name">架构</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2017/07/18/restful_design/" class="leancloud_visitors" data-flag-title="理解 RESTful">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="什么是-RESTful"><a href="#什么是-RESTful" class="headerlink" title="什么是 RESTful"></a>什么是 RESTful</h3><p>REST 是 Representation State Transfer 的缩写，具体的含义是“资源表现层的状态转化”。如果一个架构符合 REST 原则，那么它就被称为 RESTful 的。要理解 REST 原则，我们需要理解如下的一些概念。</p>
<h4 id="资源及其表现"><a href="#资源及其表现" class="headerlink" title="资源及其表现"></a>资源及其表现</h4><p>对于网络上的信息，例如一段文本，一个网页，一张图片，或一段音乐，都可以被称为资源。它们在网络上由一个具体的 URI 进行指向。当我们需要获取这个字段时，访问对应的 URI 就可以了。<br>而资源是一种信息实体，它会有很多具体的表现形式，例如 HTML 格式、JSON 格式等。URI只代表资源的实体，而最后例如“.html”等后缀名则是这个资源的具体表现形式。</p>
<h4 id="状态转化"><a href="#状态转化" class="headerlink" title="状态转化"></a>状态转化</h4><p>访问一个网站，就代表了客户端和服务器的一个互动过程。在这个过程中，会涉及到数据和状态的变化。而 HTTP 协议，是一个无状态协议。这意味着，所有的状态都保存在服务器端。因此，如果客户端想要操作服务器，必须通过某种手段，让服务器端发生“状态转化”。而这种转化是建立在资源的表现层上的，所以就是“资源表现层状的态转化”。</p>
<h3 id="实践原则"><a href="#实践原则" class="headerlink" title="实践原则"></a>实践原则</h3><p>在具体使用 RESTful 架构的时候，如下的原则通常是一种比较好的实践方式：</p>
<ul>
<li>URI 表示的是一种资源，而不是一个动作，因此避免使用动词；</li>
<li>在 HTTP 请求的 header 中用 Accept 和 Content-Type 来指定资源的表现形式，而不是通过后缀；</li>
<li>对资源的操作使用 HTTP 协议中定义的基本操作来进行：GET 获取资源，POST 新建资源或更新资源，PUT 更新资源，DELETE 删除资源。</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/07/16/python_global_variable_import/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="柿子">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="柿子的果盘">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/16/python_global_variable_import/" itemprop="url">Python 共享变量</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-16T00:00:00+08:00">
                2017-07-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/开发语言/" itemprop="url" rel="index">
                    <span itemprop="name">开发语言</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2017/07/16/python_global_variable_import/" class="leancloud_visitors" data-flag-title="Python 共享变量">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>今天开发的时候碰到一个坑，在一个数据库模块中定义了一个 Redis 的连接，初始化以后，在具体的业务模块中获取 Redis 连接怎么都是 None。经过排查，发现自己对于 Python 的多模块共享变量的 import 机制缺乏了解，于是查阅资料，做个总结。</p>
<h3 id="碰到的问题"><a href="#碰到的问题" class="headerlink" title="碰到的问题"></a>碰到的问题</h3><p>简化以后的伪代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># redis.py</span></div><div class="line"></div><div class="line">redis_conn = <span class="keyword">None</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">config_redis_conn</span><span class="params">(conf)</span>:</span></div><div class="line">    redis_conn = init_new_redis(conf)</div></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># bootstrap.py</span></div><div class="line"></div><div class="line"><span class="keyword">from</span> redis <span class="keyword">import</span> config_redis_conn</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    config_redis_conn(&#123;&#125;)</div></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># business_logic.py</span></div><div class="line"><span class="keyword">from</span> redis <span class="keyword">import</span> redis_conn</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">logic</span><span class="params">()</span>:</span></div><div class="line">    redis_conn.set(<span class="string">'A'</span>, <span class="string">'B'</span>)</div></pre></td></tr></table></figure>
<p>在 business_logic 使用 redis_conn 的时候，会发现 redis_conn 是 None，即使已经经过 bootstrap 的初始化。</p>
<h3 id="Python-的-import-机制"><a href="#Python-的-import-机制" class="headerlink" title="Python 的 import 机制"></a>Python 的 import 机制</h3><p>Python import 包的机制是：import 进来的模块和默认的系统模块，都放在 sys.module 这个字典里面。当模块再次 import 的时候，会先去 sys.module 里面检查是否已经 import 了，如果已经 import 了，就不再重复 import，否则就 import 进来。<br>from redis import redis_conn 这样的方式引用，就相当于在 business_logic.py 文件中写了一行代码 redis_conn = None，此时 redis_conn 就是 business_logic.py 自己命名空间中的变量。所以 redis_conn 只在 business_logic.py 中有效，因此即使在 bootstrap.py 中初始化了 redis_conn，business_logic.py 中的 redis_conn 依旧没有改变。换种说法，实际上<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> redis <span class="keyword">import</span> redis_conn</div></pre></td></tr></table></figure></p>
<p>等同于<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">improt redis</div><div class="line">redis_conn = redis.redis_conn</div></pre></td></tr></table></figure></p>
<p>所以，如果需要共享变量，就不要使用 from file import x 这种形式，而是使用 import file，然后就可以通过 file.x 来使用，然后 file.x=’abc’ 进行修改。这样都这样处理全局性的变量就可以共享的。也就是保持一个独立的namespace，这样python不会再次导入，从而实现共享。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/07/01/thrift_introduction/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="柿子">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="柿子的果盘">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/01/thrift_introduction/" itemprop="url">Thrift 入门篇</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-01T00:00:00+08:00">
                2017-07-01
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/开源项目/" itemprop="url" rel="index">
                    <span itemprop="name">开源项目</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2017/07/01/thrift_introduction/" class="leancloud_visitors" data-flag-title="Thrift 入门篇">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>Apache Thrift 是由 Facebook 开发的远程服务调用框架，它采用接口描述语言（IDL）定义并创建服务，支持可扩展的跨语言服务开发，所包含的代码生成引擎可以在多种语言中，如 C++, Java, Python, PHP, Ruby, Erlang, Perl, Haskell, C#, Cocoa, Smalltalk 等创建高效的、无缝的服务，其传输数据采用二进制格式，相对 XML 和 JSON 体积更小，对于高并发、大数据量和多语言的环境更有优势。</p>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><ul>
<li>下载 <a href="http://www.boost.org/" target="_blank" rel="external">boost</a> 并安装：</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">./bootstrap.sh</div><div class="line">sudo ./b2 threading=multi address-model=64 variant=release stage install</div></pre></td></tr></table></figure>
<ul>
<li>下载 <a href="http://libevent.org/" target="_blank" rel="external">libevent</a> 并安装：</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">./configure --prefix=/usr/<span class="built_in">local</span></div><div class="line">make</div><div class="line">sudo make install</div></pre></td></tr></table></figure>
<p>在执行 make 的时候可能会碰到一个问题：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">/Library/Developer/CommandLineTools/usr/bin/make  all-am</div><div class="line">  CC       libevent_openssl_la-bufferevent_openssl.lo</div><div class="line">bufferevent_openssl.c:66:10: fatal error: <span class="string">'openssl/bio.h'</span> file not found</div><div class="line"><span class="comment">#include &lt;openssl/bio.h&gt;</span></div><div class="line">         ^</div><div class="line">1 error generated.</div><div class="line">make[1]: *** [libevent_openssl_la-bufferevent_openssl.lo] Error 1</div><div class="line">make: *** [all] Error 2</div></pre></td></tr></table></figure></p>
<p>我的解决方案是执行如下命令：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./configure LDFLAGS=<span class="string">'-L/usr/local/opt/openssl/lib'</span> CPPFLAGS=<span class="string">'-I/usr/local/opt/openssl/include'</span></div></pre></td></tr></table></figure></p>
<ul>
<li>下载 Thrift 并编译</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">./configure --prefix=/usr/<span class="built_in">local</span>/ --with-boost=/usr/<span class="built_in">local</span> --with-libevent=/usr/<span class="built_in">local</span></div><div class="line">make</div><div class="line">sudo make install</div></pre></td></tr></table></figure>
<p>  这边可能会碰到一个问题，就是 mac 中默认安装了 bison 2.3 版本，并配置了路径在 path 中。<br>  需要安装最新的版本 3.0.4, 并将 /usr/bin 中的 bison 删除，将bison 3.0.4 复制到 /usr/bin 中：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">brew install bison</div><div class="line"><span class="built_in">cd</span> /usr/bin</div><div class="line">sudo mv bison bison.2.3</div><div class="line">sudo cp /usr/<span class="built_in">local</span>/Cellar/bison/3.0.4/bin/bison bxison</div></pre></td></tr></table></figure></p>
<p>  如果安装了 Xcode，那有可能是 Xcode 自带的 bison。<br>  将 Xcode 的 bison 改名后编译，编译完以后再把名字改回来。<br>  路径：/Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/<br>  此外，如果不需要其它语言的话，可以用 “–without” 选项将其排除，例如 “–without-perl”，否则可能因为本地环境配置的问题导致编译失败。</p>
<h3 id="一个简单的例子"><a href="#一个简单的例子" class="headerlink" title="一个简单的例子"></a>一个简单的例子</h3><h4 id="例子的文件结构"><a href="#例子的文件结构" class="headerlink" title="例子的文件结构"></a>例子的文件结构</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">├── client.py</div><div class="line">├── gen-py</div><div class="line">│   ├── __init__.py</div><div class="line">│   └── helloworld</div><div class="line">│       ├── HelloWorld-remote</div><div class="line">│       ├── HelloWorld.py</div><div class="line">│       ├── __init__.py</div><div class="line">│       ├── constants.py</div><div class="line">│       └── ttypes.py</div><div class="line">├── helloworld.thrift</div><div class="line">└── server.py</div></pre></td></tr></table></figure>
<h4 id="定义-helloword-thrift-文件"><a href="#定义-helloword-thrift-文件" class="headerlink" title="定义 helloword.thrift 文件"></a>定义 helloword.thrift 文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">service HelloWorld &#123;</div><div class="line">  string ping(),</div><div class="line">  string say(1:string msg)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="自动生成代码"><a href="#自动生成代码" class="headerlink" title="自动生成代码"></a>自动生成代码</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">thrift --gen py helloword.thrift</div></pre></td></tr></table></figure>
<h4 id="生成-server-端的代码"><a href="#生成-server-端的代码" class="headerlink" title="生成 server 端的代码"></a>生成 server 端的代码</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python</span></div><div class="line"></div><div class="line"><span class="keyword">import</span> socket</div><div class="line"><span class="keyword">import</span> sys</div><div class="line"></div><div class="line">sys.path.append(<span class="string">'./gen-py'</span>)</div><div class="line"><span class="keyword">from</span> helloworld <span class="keyword">import</span> HelloWorld</div><div class="line"><span class="keyword">from</span> helloworld.ttypes <span class="keyword">import</span> *</div><div class="line"><span class="keyword">from</span> thrift.transport <span class="keyword">import</span> TSocket</div><div class="line"><span class="keyword">from</span> thrift.transport <span class="keyword">import</span> TTransport</div><div class="line"><span class="keyword">from</span> thrift.protocol <span class="keyword">import</span> TBinaryProtocol</div><div class="line"><span class="keyword">from</span> thrift.server <span class="keyword">import</span> TServer</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">HelloWorldHandler</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">ping</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> <span class="string">"pong"</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">say</span><span class="params">(self, msg)</span>:</span></div><div class="line">        ret = <span class="string">"Received: "</span> + msg</div><div class="line">        <span class="keyword">print</span> ret</div><div class="line">        <span class="keyword">return</span> ret</div></pre></td></tr></table></figure>
<h4 id="加入启动服务的代码"><a href="#加入启动服务的代码" class="headerlink" title="加入启动服务的代码"></a>加入启动服务的代码</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">handler = HelloWorldHandler()</div><div class="line">processor = HelloWorld.Processor(handler)</div><div class="line">transport = TSocket.TServerSocket(<span class="string">"localhost"</span>, <span class="number">9090</span>)</div><div class="line">tfactory = TTransport.TBufferedTransportFactory()</div><div class="line">pfactory = TBinaryProtocol.TBinaryProtocolFactory()</div><div class="line">server = TServer.TSimpleServer(processor, transport, tfactory, pfactory)</div><div class="line"><span class="keyword">print</span> <span class="string">"Starting thrift server in python..."</span></div><div class="line">server.serve()</div><div class="line"><span class="keyword">print</span> <span class="string">"done!"</span></div></pre></td></tr></table></figure>
<h4 id="生成-client-端的代码"><a href="#生成-client-端的代码" class="headerlink" title="生成 client 端的代码"></a>生成 client 端的代码</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python</span></div><div class="line"></div><div class="line"><span class="keyword">import</span> sys</div><div class="line"></div><div class="line">sys.path.append(<span class="string">'./gen-py'</span>)</div><div class="line"><span class="keyword">from</span> helloworld <span class="keyword">import</span> HelloWorld</div><div class="line"><span class="keyword">from</span> thrift <span class="keyword">import</span> Thrift</div><div class="line"><span class="keyword">from</span> thrift.transport <span class="keyword">import</span> TSocket</div><div class="line"><span class="keyword">from</span> thrift.transport <span class="keyword">import</span> TTransport</div><div class="line"><span class="keyword">from</span> thrift.protocol <span class="keyword">import</span> TBinaryProtocol</div><div class="line"></div><div class="line"><span class="keyword">try</span>:</div><div class="line">    transport = TSocket.TSocket(<span class="string">'localhost'</span>, <span class="number">9090</span>)</div><div class="line">    transport = TTransport.TBufferedTransport(transport)</div><div class="line">    protocol = TBinaryProtocol.TBinaryProtocol(transport)</div><div class="line">    client = HelloWorld.Client(protocol)</div><div class="line">    transport.open()</div><div class="line"></div><div class="line">    <span class="keyword">print</span> <span class="string">"client - ping"</span></div><div class="line">    <span class="keyword">print</span> <span class="string">"server - "</span> + client.ping()</div><div class="line">    <span class="keyword">print</span> <span class="string">"client - say"</span></div><div class="line">    msg = client.say(<span class="string">"Hello!"</span>)</div><div class="line">    <span class="keyword">print</span> <span class="string">"server - "</span> + msg</div><div class="line"></div><div class="line">    transport.close()</div><div class="line"><span class="keyword">except</span> Thrift.TException, ex:</div><div class="line">    <span class="keyword">print</span> <span class="string">"%s"</span> % (ex.message)</div></pre></td></tr></table></figure>
<h4 id="运行代码"><a href="#运行代码" class="headerlink" title="运行代码"></a>运行代码</h4><p>运行 server 端代码和 client 端代码，可以在 server 端看到如下日志：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Starting thrift server <span class="keyword">in</span> python...</div><div class="line">Received: Hello!</div></pre></td></tr></table></figure></p>
<p>在 client 端看到如下日志：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">client - ping</div><div class="line">server - pong</div><div class="line">client - say</div><div class="line">server - Received: Hello!</div></pre></td></tr></table></figure></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/06/28/python_package/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="柿子">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="柿子的果盘">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/06/28/python_package/" itemprop="url">Python 包管理</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-28T00:00:00+08:00">
                2017-06-28
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/开发语言/" itemprop="url" rel="index">
                    <span itemprop="name">开发语言</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2017/06/28/python_package/" class="leancloud_visitors" data-flag-title="Python 包管理">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>之前在用 Ruby，Java 和 NodeJs 的时候，都有比较明确的包或模块管理的概念。换工作以后开始使用 Python，由于我们的开发机是一个多人使用的环境（物理机），因此经常会发生包路径的优先级被修改的情况。而我之前对于 Python 的包管理并不熟悉，因此当我在使用环境的时候，被人修改了 pythonpath，结果让我排查了很久才找到原因。因此，特地查阅一下资料，发现有一篇<a href="https://github.com/dccrazyboy/pyeco/blob/master/pyeco.rst" target="_blank" rel="external">Python开发生态环境简介</a>写得很详细，在这里留个记录。</p>
<h3 id="理解包"><a href="#理解包" class="headerlink" title="理解包"></a>理解包</h3><p>Python 没有一个默认的包管理设施。事实上，包的概念在 Python 中是相当弱的。Python 代码被组织为模块。一个模块可能由包含一个函数的单一文件组成，也可能由包含多个模块的目录组成。 包和模块的区别非常小，并且每个模块都能被理解为包。</p>
<p>那么包和模块的区别到底是什么（如果有的话）？为了明白这个，你首先应该明白 Python 是如何查找模块的。</p>
<p>如同别的编程环境一样，Python中的一些函数和类（例如str,len,Exception等）在全局（叫做内置函数）都是可用的。 别的就需要通过手动 import 进来。例如:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> os</div><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> os.path <span class="keyword">import</span> basename, dirname</div></pre></td></tr></table></figure>
<p>这个包一定存在你的机子上，这样才能被 import 语句导入。但Python是如何知道这些模块的位置呢？这些位置信息在你安装Python虚拟机时就被自动设置好了，并且依赖于你的目标平台。包的路径可以在 sys.path 中查询。下面是在我的笔记本上的结果，运行环境是 Ubuntu 11.10。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> sys</div><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">print</span> sys.path</div><div class="line">[<span class="string">''</span>,</div><div class="line"> <span class="string">'/usr/lib/python2.7'</span>,</div><div class="line"> <span class="string">'/usr/lib/python2.7/plat-linux2'</span>,</div><div class="line"> <span class="string">'/usr/lib/python2.7/lib-tk'</span>,</div><div class="line"> <span class="string">'/usr/lib/python2.7/lib-old'</span>,</div><div class="line"> <span class="string">'/usr/lib/python2.7/lib-dynload'</span>,</div><div class="line"> <span class="string">'/usr/local/lib/python2.7/dist-packages'</span>,</div><div class="line"> <span class="string">'/usr/lib/python2.7/dist-packages'</span>,</div><div class="line"> <span class="string">'/usr/lib/python2.7/dist-packages/PIL'</span>,</div><div class="line"> <span class="string">'/usr/lib/python2.7/dist-packages/gst-0.10'</span>,</div><div class="line"> <span class="string">'/usr/lib/python2.7/dist-packages/gtk-2.0'</span>,</div><div class="line"> <span class="string">'/usr/lib/pymodules/python2.7'</span>,</div><div class="line"> <span class="string">'/usr/lib/python2.7/dist-packages/ubuntu-sso-client'</span>,</div><div class="line"> <span class="string">'/usr/lib/python2.7/dist-packages/ubuntuone-client'</span>,</div><div class="line"> <span class="string">'/usr/lib/python2.7/dist-packages/ubuntuone-control-panel'</span>,</div><div class="line"> <span class="string">'/usr/lib/python2.7/dist-packages/ubuntuone-couch'</span>,</div><div class="line"> <span class="string">'/usr/lib/python2.7/dist-packages/ubuntuone-installer'</span>,</div><div class="line"> <span class="string">'/usr/lib/python2.7/dist-packages/ubuntuone-storage-protocol'</span>]</div></pre></td></tr></table></figure>
<p>这里给出了 Python 搜索包的路径。它将从最上面开始找，直到找到一个名字相符的。 这表明如果两个不同的路径分别包含了两个具有相同名字的包，搜索将在找到第一个名字的时候停止，然后将永远不会往下查找。</p>
<p>正如你所猜的，包搜索路径很容易被劫持，为了确保 Python 首先载入你的包，所需做的如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>sys.path.insert(<span class="number">0</span>, <span class="string">'/path/to/my/packages'</span>)</div></pre></td></tr></table></figure></p>
<p>尽管这个方法在很多情况下都很好用，但一定要小心不要滥用。 只有当必要时再使用！不要滥用！<br>site 模块控制包的搜索路径。当 Python 虚拟机初始化时它会自动被导入。</p>
<h3 id="PYTHONPATH-变量"><a href="#PYTHONPATH-变量" class="headerlink" title="PYTHONPATH 变量"></a>PYTHONPATH 变量</h3><p>PYTHONPATH 是一个用来增加默认包搜索目录的环境变量。可以认为它是对于 Python 的一个特殊的 PATH 变量。 它仅仅是一个通过“:”分割，包含 Python 模块目录的列表（并不是类似于 sys.path 的 Python list）。 它可能就类似下面这样：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">export</span> PYTHONPATH=/path/to/some/directory:/path/to/another/directory:/path/to/yet/another/directory</div></pre></td></tr></table></figure></p>
<p>有时候你可能并不想覆盖掉现存的 PYTHONPATH ，而仅仅是希望添加新目录到头部或尾部。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">export</span> PYTHONPATH=<span class="variable">$PYTHONPATH</span>:/path/to/some/directory    <span class="comment"># Append</span></div><div class="line"><span class="built_in">export</span> PYTHONPATH=/path/to/some/directory:<span class="variable">$PYTHONPATH</span>    <span class="comment"># Prepend</span></div></pre></td></tr></table></figure></p>
<p>PYTHONPATH，sys.path.insert 这些方法并非完美，我们最好也不要用这些方法。使用它们，你可能可以解决本地的开发环境问题，但它在别的环境下也许并不适用。</p>
<p>我们现在明白的Python如何找到安装的包路径，现在让我们回到开始那个问题。 模块和包的区别到底是什么？包是一个模块或模块/子模块的集合，一般情况下被压缩到一个压缩包中。 其中包含：</p>
<ol>
<li>依赖信息</li>
<li>将文件拷贝到标准的包搜索路径的指令</li>
<li>编译指令(如果在安装前代码必须被编译的话</li>
</ol>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/06/26/python_decorator/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="柿子">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="柿子的果盘">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/06/26/python_decorator/" itemprop="url">Python 装饰器</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-26T00:00:00+08:00">
                2017-06-26
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/开发语言/" itemprop="url" rel="index">
                    <span itemprop="name">开发语言</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2017/06/26/python_decorator/" class="leancloud_visitors" data-flag-title="Python 装饰器">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="模式动机"><a href="#模式动机" class="headerlink" title="模式动机"></a>模式动机</h3><p>通常情况下，在不改变类或者对象功能的基础上，我们有两种方式可以实现给一个类或对象增加行为：</p>
<ul>
<li>继承机制：通过继承一个现有类可以使得子类在拥有自身方法的同时还拥有父类的方法。但是这种方法是静态的，用户不能控制增加行为的方式和时机。</li>
<li>关联机制：将一个类的对象嵌入另一个对象中，由另一个对象来决定是否调用嵌入对象的行为以便扩展自己的行为，我们称这个嵌入的对象为装饰器 (Decorator)</li>
</ul>
<p>装饰器本质上是在不对现有函数做任何代码变动的前提下，增加额外的功能。它经常用于有切面需求的场景，比如：插入日志、性能测试、事务处理、缓存、权限校验等场景。</p>
<h3 id="基础：函数是对象"><a href="#基础：函数是对象" class="headerlink" title="基础：函数是对象"></a>基础：函数是对象</h3><p>在 Python 中，函数也是对象，它可以：</p>
<ul>
<li>赋值给变量</li>
<li>作为形参传递给其它的函数</li>
<li>作为函数的返回值</li>
<li>在一个函数的内部定义另外一个函数</li>
</ul>
<p>而这些就是 Python 装饰器的基础。</p>
<h3 id="简单装饰器"><a href="#简单装饰器" class="headerlink" title="简单装饰器"></a>简单装饰器</h3><p>假设我们当前有一个处理业务逻辑的函数，如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">business_logic</span><span class="params">()</span>:</span></div><div class="line">    print(<span class="string">'deal with business logic'</span>)</div></pre></td></tr></table></figure></p>
<p>现在有一个需求，希望可以记录下函数调用的日志，于是在函数中添加日志代码：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">business_logic</span><span class="params">()</span>:</span></div><div class="line">    logging.info(<span class="string">'business_logic is invoked!'</span>)</div><div class="line">    print(<span class="string">'deal with business logic'</span>)</div></pre></td></tr></table></figure></p>
<p>而在正常的开发过程中，会有很多函数有类似的需求。为了减少重复写代码，我们可以重新定义一个函数：专门处理日志 ，日志处理完之后再执行真正的业务代码：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">api_logging</span><span class="params">(func)</span>:</span></div><div class="line">    logging.info(<span class="string">"%s is invoked!"</span> % func.__name__)</div><div class="line">    func()</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">business_logic</span><span class="params">()</span>:</span></div><div class="line">    print(<span class="string">'deal with business logic'</span>)</div></pre></td></tr></table></figure></p>
<p>但是这样的话，我们每次都需要将包含业务逻辑的函数作为参数传递给 api_logging 函数。这样的话，就破坏了原有的调用逻辑。<br>使用装饰器模式，我们可以把上述的逻辑改为下面的实现：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">api_logging</span><span class="params">(func)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(*args, **kwargs)</span>:</span></div><div class="line">        logging.info(<span class="string">"%s is invoked!"</span> % func.__name__)</div><div class="line">        <span class="keyword">return</span> func(*args, **kwargs)</div><div class="line">    <span class="keyword">return</span> wrapper</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">business_logic</span><span class="params">()</span>:</span></div><div class="line">    print(<span class="string">'deal with business logic'</span>)</div><div class="line"></div><div class="line">business_logic = api_logging(business_logic)</div><div class="line">business_logic()</div></pre></td></tr></table></figure></p>
<p>通过这样的方式，直接调用 business_logic 就可以按照期望地打印调用日志，并且执行业务逻辑了。但是这样每次定义新函数的时候，需要多加一个函数赋值语句。<br>Python 提供了一个语法糖，能省去这个函数赋值语句，就是 @ 符号。我们可以把上述的代码改为如下形式：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">api_logging</span><span class="params">(func)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(*args, **kwargs)</span>:</span></div><div class="line">        logging.info(<span class="string">"%s is invoked!"</span> % func.__name__)</div><div class="line">        <span class="keyword">return</span> func(*args, **kwargs)</div><div class="line">    <span class="keyword">return</span> wrapper</div><div class="line"></div><div class="line"><span class="meta">@api_logging</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">business_logic</span><span class="params">()</span>:</span></div><div class="line">    print(<span class="string">'deal with business logic'</span>)</div><div class="line"></div><div class="line">business_logic()</div></pre></td></tr></table></figure></p>
<p>这样就创建了一个简单的装饰器。</p>
<h3 id="functions-wraps"><a href="#functions-wraps" class="headerlink" title="functions.wraps"></a>functions.wraps</h3><p>使用装饰器有一个缺点，就是原函数的原信息不见了，比如 <strong>name</strong>、<strong>doc</strong> 等，具体例子如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">api_logging</span><span class="params">(func)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(*args, **kwargs)</span>:</span></div><div class="line">        <span class="keyword">print</span> func.__name__</div><div class="line">        <span class="keyword">print</span> func.__doc__</div><div class="line">        logging.info(<span class="string">"%s is invoked!"</span> % func.__name__)</div><div class="line">        <span class="keyword">return</span> func(*args, **kwargs)</div><div class="line">    <span class="keyword">return</span> wrapper</div><div class="line"></div><div class="line"><span class="meta">@api_logging</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">business_logic</span><span class="params">()</span>:</span></div><div class="line">    print(<span class="string">'deal with business logic'</span>)</div><div class="line"></div><div class="line">api_logging(business_logic)()</div></pre></td></tr></table></figure></p>
<p>不难发现，函数 business_logic 的信息被 wrapper 取代了。Python 提供了一个装饰器 functools.wraps，它能把原函数的元信息拷贝到装饰器里面的 func 函数中，使得装饰器里面的 func 函数拥有和原函数一样的元信息。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> wraps</div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">api_logging</span><span class="params">(func)</span>:</span></div><div class="line"><span class="meta">    @wraps(func)</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(*args, **kwargs)</span>:</span></div><div class="line">        <span class="keyword">print</span> func.__name__</div><div class="line">        <span class="keyword">print</span> func.__doc__</div><div class="line">        logging.info(<span class="string">"%s is invoked!"</span> % func.__name__)</div><div class="line">        <span class="keyword">return</span> func(*args, **kwargs)</div><div class="line">    <span class="keyword">return</span> wrapper</div></pre></td></tr></table></figure></p>
<h3 id="带参数的装饰器"><a href="#带参数的装饰器" class="headerlink" title="带参数的装饰器"></a>带参数的装饰器</h3><p>装饰器还有更大的灵活性，例如上述的例子中，我们希望针对不同的业务接口的调用使用不同日志级别，那么需要给装饰器传入日志级别作为参数，具体需要的改动如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">api_logging</span><span class="params">(level)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">decorator</span><span class="params">(func)</span>:</span></div><div class="line">        <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(*args, **kwargs)</span>:</span></div><div class="line">            <span class="keyword">if</span> level == <span class="string">"warn"</span>:</div><div class="line">                logging.warn(<span class="string">"%s is invoked!"</span> % func.__name__)</div><div class="line">            <span class="keyword">elif</span> level == <span class="string">"info"</span>:</div><div class="line">                logging.info(<span class="string">"%s is invoked!"</span> % func.__name__)</div><div class="line">            <span class="keyword">return</span> func(*args, **kwargs)</div><div class="line">        <span class="keyword">return</span> wrapper</div><div class="line">    <span class="keyword">return</span> decorator</div><div class="line"></div><div class="line"><span class="meta">@api_logging('warn')</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">business_logic</span><span class="params">()</span>:</span></div><div class="line">    print(<span class="string">'deal with business logic'</span>)</div><div class="line"></div><div class="line">business_logic()</div></pre></td></tr></table></figure></p>
<p>上述处理方法的核心思想很简单。最外层的函数 api_logging() 接受参数并将它们作用在内部的装饰器函数上面。内层的函数 decorate() 接受一个函数作为参数，然后在函数上面放置一个包装器。这里的关键点是包装器是可以使用传递给 api_logging() 的参数。</p>
<h3 id="类装饰器"><a href="#类装饰器" class="headerlink" title="类装饰器"></a>类装饰器</h3><p>相比函数装饰器，类装饰器更灵活，封装性也更好。当使用 @ 符号将类装饰器附加到函数上时，会调用类的 <strong>call</strong> 方法：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Logging</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, func)</span>:</span></div><div class="line">        self._func = func</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self)</span>:</span></div><div class="line">        logging.info(<span class="string">"%s is invoked!"</span> % self._func.__name__)</div><div class="line">        self._func()</div><div class="line"></div><div class="line"><span class="meta">@Logging</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">business_logic</span><span class="params">()</span>:</span></div><div class="line">    print(<span class="string">'deal with business logic'</span>)</div><div class="line"></div><div class="line">business_logic()</div></pre></td></tr></table></figure></p>
<p>通过这种方式，我们可以在日志处理的逻辑发生多样化时，还可以继承 Logging 进行实现。</p>
<h3 id="装饰器顺序"><a href="#装饰器顺序" class="headerlink" title="装饰器顺序"></a>装饰器顺序</h3><p>一个函数可以同时定义多个装饰器，比如：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@decorator1</span></div><div class="line"><span class="meta">@decorator2</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">func</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">pass</span></div></pre></td></tr></table></figure></p>
<p>它的执行顺序是从里到外的，先执行最里面的装饰器，然后依次向外，直到最外层的装饰器，等效于：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">func = decorator1(decorator2(func))</div></pre></td></tr></table></figure></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/06/22/restart/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="柿子">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="柿子的果盘">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/06/22/restart/" itemprop="url">胜败乃兵家常事，少侠请重新来过</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-22T10:12:23+08:00">
                2017-06-22
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/06/22/restart/" class="leancloud_visitors" data-flag-title="胜败乃兵家常事，少侠请重新来过">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>今年春节过完以后，各种杂事缠身，先是小团团提早出生闹得一阵鸡飞狗跳，再是换了份工作，匆忙地离职再入职。由于新工作的技术栈跟之前完全不同，领域也几乎没有相关性，所以很是折腾了一番。</p>
<p>待到一切都稍微上了正轨，回来看这个博客，发现当时离职的时候很是潇洒地把公司开发机的硬盘格式化了，忘记把博客的源代码备份了……颇有种小时候玩仙剑的时候看到屏幕上出现“胜败乃兵家常事，少侠请重新来过”时的感受。</p>
<p>于是，一切重来，赶紧把之前写的文章拷贝下来，慢慢重新排版了。之前剩下的几篇写完还没发表的 Redis 相关的博客只能有时间再来补上了。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/12/05/redis_malloc/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="柿子">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="柿子的果盘">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/12/05/redis_malloc/" itemprop="url">Redis内存管理机制</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-12-05T00:00:00+08:00">
                2016-12-05
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/开源项目/" itemprop="url" rel="index">
                    <span itemprop="name">开源项目</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2016/12/05/redis_malloc/" class="leancloud_visitors" data-flag-title="Redis内存管理机制">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在阅读各类基本数据结构的时候，看到分配空间或调整空间时，使用的是形如 zmalloc 的函数。由于它的用法与 malloc 无异，所以一直把它等同于 malloc 进行阅读，直到看到 object.c 最后新增加的内存数据统计时，才注意到一些内存统计相关的功能，于是阅读了一下 Redis 内存管理相关的代码。</p>
<h3 id="Redis-的内存管理策略"><a href="#Redis-的内存管理策略" class="headerlink" title="Redis 的内存管理策略"></a>Redis 的内存管理策略</h3><p>Redis 在进行内存空间分配的时候，会在分配的空间前面增加一个额外的空间，用于保存分配的空间的大小。同时，使用一个全局变量 used_memory 来记录 Redis 总共申请分配的空间大小。</p>
<h3 id="第三方的-malloc-库"><a href="#第三方的-malloc-库" class="headerlink" title="第三方的 malloc 库"></a>第三方的 malloc 库</h3><p>Redis 支持使用第三方的 malloc 库（tcmalloc、 jemalloc 以及苹果平台的 malloc.h）来管理内存：</p>
<ul>
<li>tcmalloc：tcmalloc 是 google perftool 的一部分，与一般的内存池不同，它直接与 OS 打交道，内存闲置时 OS 会进行回收 (STL 内存池就不回收)，同时使用 TLS (Thread local storage) 管理内存池，避免一个线程内分配内存都要同步。</li>
<li>jemalloc：jemalloc 与 tcmalloc相似，作者 Jason Evans 是 Free BSD 开发人员，性能与使用率与 tcmalloc 不相伯仲。tcmalloc 更方便与 google perftool 集成，进行性能评测。</li>
</ul>
<p>对于这些第三方库而言，有两个比较重要的特点：</p>
<ul>
<li>包括苹果平台的 malloc.h，这些第三方库与 STL 标准库可以通过调用 malloc_size(p) 直接获得指针 p 在分配时获得的空间大小。</li>
<li>在分配小空间时，这些第三方库可能会多分配一些内存空间以供使用，例如对于 tcmalloc 而言，收到 833 字节到 1024 字节的内存分配请求，都会分配一个 1024 字节大小的内存块，这样会产生内存空间碎片。</li>
</ul>
<p>关于这些第三方库的实现原理，可以参考：<br><a href="http://www.360doc.com/content/13/0915/09/8363527_314549128.shtml。" target="_blank" rel="external">http://www.360doc.com/content/13/0915/09/8363527_314549128.shtml。</a></p>
<p>在使用第三方库的时候，直接用这些库中的函数替换掉预先定义的函数，特别注意到，这些第三方库都实现了获取空间大小的方法，统一重新定义为 zmalloc_size(p)，同时使用 HAVE_MALLOC_SIZE 标记是否由 Redis 自己管理分配的空间大小（为 1 表示不由自己管理）：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(USE_TCMALLOC)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> ZMALLOC_LIB (<span class="meta-string">"tcmalloc-"</span> __xstr(TC_VERSION_MAJOR) <span class="meta-string">"."</span> __xstr(TC_VERSION_MINOR))</span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;google/tcmalloc.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> (TC_VERSION_MAJOR == 1 &amp;&amp; TC_VERSION_MINOR &gt;= 6) || (TC_VERSION_MAJOR &gt; 1)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> HAVE_MALLOC_SIZE 1</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> zmalloc_size(p) tc_malloc_size(p)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">else</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">error</span> <span class="meta-string">"Newer version of tcmalloc required"</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">elif</span> defined(USE_JEMALLOC)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> ZMALLOC_LIB (<span class="meta-string">"jemalloc-"</span> __xstr(JEMALLOC_VERSION_MAJOR) <span class="meta-string">"."</span> __xstr(JEMALLOC_VERSION_MINOR) <span class="meta-string">"."</span> __xstr(JEMALLOC_VERSION_BUGFIX))</span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;jemalloc/jemalloc.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> (JEMALLOC_VERSION_MAJOR == 2 &amp;&amp; JEMALLOC_VERSION_MINOR &gt;= 1) || (JEMALLOC_VERSION_MAJOR &gt; 2)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> HAVE_MALLOC_SIZE 1</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> zmalloc_size(p) je_malloc_usable_size(p)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">else</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">error</span> <span class="meta-string">"Newer version of jemalloc required"</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">elif</span> defined(__APPLE__)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;malloc/malloc.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> HAVE_MALLOC_SIZE 1</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> zmalloc_size(p) malloc_size(p)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(USE_TCMALLOC)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> malloc(size) tc_malloc(size)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> calloc(count,size) tc_calloc(count,size)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> realloc(ptr,size) tc_realloc(ptr,size)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> free(ptr) tc_free(ptr)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">elif</span> defined(USE_JEMALLOC)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> malloc(size) je_malloc(size)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> calloc(count,size) je_calloc(count,size)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> realloc(ptr,size) je_realloc(ptr,size)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> free(ptr) je_free(ptr)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div></pre></td></tr></table></figure>
<h3 id="非第三方的内存管理"><a href="#非第三方的内存管理" class="headerlink" title="非第三方的内存管理"></a>非第三方的内存管理</h3><p>在使用标准库提供的内存操作函数时，Redis 会额外多申请 PREFIX_SIZE 定义的大小的空间，用于存储申请空间的大小。同时，每次申请或者更新空间大小时，需要同时更新 used_memory 的值，以 zmalloc 为例：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">define</span> update_zmalloc_stat_alloc(__n) do &#123; \</span></div><div class="line">    size_t _n = (__n); \</div><div class="line">    <span class="meta-keyword">if</span> (_n&amp;(sizeof(long)-1)) _n += sizeof(long)-(_n&amp;(sizeof(long)-1)); \</div><div class="line">    <span class="meta-keyword">if</span> (zmalloc_thread_safe) &#123; \</div><div class="line">        atomicIncr(used_memory,__n,used_memory_mutex); \</div><div class="line">    &#125; <span class="meta-keyword">else</span> &#123; \</div><div class="line">        used_memory += _n; \</div><div class="line">    &#125; \</div><div class="line">&#125; while(0)</div><div class="line"><span class="function"><span class="keyword">void</span> *<span class="title">zmalloc</span><span class="params">(<span class="keyword">size_t</span> size)</span> </span>&#123;</div><div class="line">    <span class="keyword">void</span> *ptr = <span class="built_in">malloc</span>(size+PREFIX_SIZE); <span class="comment">// 申请一个指定大小加上 header 的空间</span></div><div class="line">    <span class="keyword">if</span> (!ptr) zmalloc_oom_handler(size);</div><div class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> HAVE_MALLOC_SIZE</span></div><div class="line">    update_zmalloc_stat_alloc(zmalloc_size(ptr)); <span class="comment">// 计算空间大小</span></div><div class="line">    <span class="keyword">return</span> ptr;</div><div class="line"><span class="meta">#<span class="meta-keyword">else</span></span></div><div class="line">    *((<span class="keyword">size_t</span>*)ptr) = size; <span class="comment">// 自己维护空间的大小</span></div><div class="line">    update_zmalloc_stat_alloc(size+PREFIX_SIZE); <span class="comment">// 计算空间的大小</span></div><div class="line">    <span class="keyword">return</span> (<span class="keyword">char</span>*)ptr+PREFIX_SIZE; <span class="comment">// 返回可以使用的空间的指针</span></div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="统计使用的内存数"><a href="#统计使用的内存数" class="headerlink" title="统计使用的内存数"></a>统计使用的内存数</h3><p>Redis 在统计使用的内存数的时候，按照如下的步骤进行尝试：</p>
<ul>
<li>如果定义了 PROC_FS，则从 /proc/[getpid()]/stat 中读取</li>
<li>如果定义了 TASK_INFO，从该进程 id 对应的 task_info_t 结构中读取 resident_size 变量</li>
<li>直接返回 used_memory</li>
</ul>
<p>由于第三方的库在分配内存空间的时候，存在空间碎片，因此，通过操作系统底层的调用函数统计出的内存占用量的数值更为准确，使用这个数值与 used_memory 的比例可以估计内存碎片的情况，而 Redis 也是这么做的：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">float</span> <span class="title">zmalloc_get_fragmentation_ratio</span><span class="params">(<span class="keyword">size_t</span> rss)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> (<span class="keyword">float</span>)rss/zmalloc_used_memory();</div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/12/01/redis_object/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="柿子">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="柿子的果盘">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/12/01/redis_object/" itemprop="url">Redis数据结构: 对象</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-12-01T00:00:00+08:00">
                2016-12-01
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/开源项目/" itemprop="url" rel="index">
                    <span itemprop="name">开源项目</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2016/12/01/redis_object/" class="leancloud_visitors" data-flag-title="Redis数据结构: 对象">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Redis 主要的基本数据结构有 SDS，双端链表，整数集合，哈希表，跳跃表，压缩表等等。Redis 并没有直接使用这些基本的数据结构，而是把它们封装成对象来进行使用，对象的类型有字符串对象（OBJ_STRING）、列表对象（OBJ_LIST）、哈希对象（OBJ_HASH）、集合对象（OBJ_SET）和有序集合对象（OBJ_ZSET）。通过这五种不同的对象类型，Redis 可以在不同的场景下使用不同的基本数据结构，从而优化空间的利用率和操作的时间复杂度。</p>
<h3 id="Redis-对象结构"><a href="#Redis-对象结构" class="headerlink" title="Redis 对象结构"></a>Redis 对象结构</h3><p>在 server.h 中定义了 redisObject 的结构：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">redisObject</span> &#123;</span></div><div class="line">    <span class="keyword">unsigned</span> type:<span class="number">4</span>;              <span class="comment">// 类型</span></div><div class="line">    <span class="keyword">unsigned</span> encoding:<span class="number">4</span>;          <span class="comment">// 编码</span></div><div class="line">    <span class="keyword">unsigned</span> lru:REDIS_LRU_BITS;  <span class="comment">// 对象最后一次被访问的时间</span></div><div class="line">    <span class="keyword">int</span> refcount;                 <span class="comment">// 引用计数</span></div><div class="line">    <span class="keyword">void</span> *ptr;                    <span class="comment">// 指向实际值的指针</span></div><div class="line">&#125; robj;</div></pre></td></tr></table></figure>
<h4 id="类型、编码、指向实际值的指针"><a href="#类型、编码、指向实际值的指针" class="headerlink" title="类型、编码、指向实际值的指针"></a>类型、编码、指向实际值的指针</h4><p>不同的类型决定了该对象是上述五种对象中的哪一种，而编码则决定了使用了何种底层的基本数据结构，具体的对应关系是：</p>
<table>
<thead>
<tr>
<th>类型</th>
<th>编码</th>
<th>对象</th>
</tr>
</thead>
<tbody>
<tr>
<td>OBJ_STRING</td>
<td>OBJ_ENCODING_INT</td>
<td>使用整数值实现的字符串对象</td>
</tr>
<tr>
<td>OBJ_STRING</td>
<td>OBJ_ENCODING_EMBSTR</td>
<td>使用 embstr 编码的 SDS 实现的字符串对象</td>
</tr>
<tr>
<td>OBJ_STRING</td>
<td>OBJ_ENCODING_RAW</td>
<td>使用 SDS 实现的字符串对象</td>
</tr>
<tr>
<td>OBJ_LIST</td>
<td>OBJ_ENCODING_QUICKLIST</td>
<td>使用快速列表实现的列表对象</td>
</tr>
<tr>
<td>OBJ_HASH</td>
<td>OBJ_ENCODING_ZIPLIST</td>
<td>使用压缩列表实现的哈希对象</td>
</tr>
<tr>
<td>OBJ_HASH</td>
<td>OBJ_ENCODING_HT</td>
<td>使用哈希表实现的哈希对象</td>
</tr>
<tr>
<td>OBJ_SET</td>
<td>OBJ_ENCODING_INTSET</td>
<td>使用整数集合实现的集合对象</td>
</tr>
<tr>
<td>OBJ_SET</td>
<td>OBJ_ENCODING_HT</td>
<td>使用哈希表实现的集合对象</td>
</tr>
<tr>
<td>OBJ_ZSET</td>
<td>OBJ_ENCODING_ZIPLIST</td>
<td>使用压缩列表实现的有序集合对象</td>
</tr>
<tr>
<td>OBJ_ZSET</td>
<td>OBJ_ENCODING_SKIPLIST</td>
<td>使用快速列表实现的有序集合对象</td>
</tr>
</tbody>
</table>
<p>具体的组合之间的转换关系和对象的细节后面再进行叙述。</p>
<h4 id="引用计数"><a href="#引用计数" class="headerlink" title="引用计数"></a>引用计数</h4><p>因为 C 语言本身没有实现垃圾回收机制，因此 Redis 自己实现了一套基于引用计数器的回收机制。而 refcount 则用于记录当前对象被程序引用的次数：</p>
<ul>
<li>对象创建时，refcount 被设置为 1</li>
<li>对象被新的程序引用时，refcount 增加 1</li>
<li>对象不再被程序引用时，refcount 减去 1</li>
<li>refcount = 0 时，销毁对象，回收空间</li>
</ul>
<p>同时，值得一提的是，Redis 在启动的时候会生成 0 - 10000 对应的字符串对象，在使用这些整数值时，所有的字符串指针会指向这些预先生成的字符串对象。这样能够大量节省这些常用字符串的存储空间。那么为什么只对数值类型的字符串进行共享呢？因为程序判定是创建新的字符串对象，还是使用共享对象时，需要对存储的内容进行比对，整数型字符串对象的比对时间为 O(1)，而普通的字符串则需要耗费 O(N)。而由于这样的比对操作在每次创建字符串对象或修改的时候都需要进行，十分频繁，会严重影响 Redis 的性能。</p>
<h4 id="对象最后一次被访问时间"><a href="#对象最后一次被访问时间" class="headerlink" title="对象最后一次被访问时间"></a>对象最后一次被访问时间</h4><p>这个属性记录了对象的空转时长，使用OBJECT IDLETIME可以查看对象的空转时长。注意，除了该命令以外的其它命令都会更新这个属性。<br>当 Redis 的 maxmemory 选项被设置以后，Redis 占用的空间到达 maxmemory 设置的值时，Redis 就会开始清理空转时间较长的对象来获取可用的空间。</p>
<h3 id="字符串对象"><a href="#字符串对象" class="headerlink" title="字符串对象"></a>字符串对象</h3><p>embstr 编码的字符串和普通 SDS 字符串的区别是：对象结构和字符串结构（字符串结构仍是 SDS）是否存储在连续的空间中。它的好处是：</p>
<ul>
<li>只需要一次分配空间和释放空间的操作，而普通 SDS 字符串实现的字符串对象需要两次</li>
<li>由于字符串对象和字符串内容被分配在连续的空间中，能更好地利用缓存</li>
</ul>
<p>字符串对象在选择底层的数据结构实现时，遵循如下的原则：</p>
<ul>
<li>可以用 long 类型保存的字符串用整数值保存</li>
<li>长度小于 44 字节的字符串用 embstr 编码的字符串对象保存</li>
<li>无法用 long 类型保存的，且转化为字符串长度大于 44 字节的数值类型，或长度大于 44 的字符串则用普通的 SDS 对应的字符串类型保存</li>
</ul>
<p>为什么是 44 字节呢？ 因为 EMBSTR 的对象和字符串都保存在一个连续的内存空间中，包括了</p>
<ul>
<li>redisObject 结构 type、encoding 和 lru 共占用 4 个字节，refcount 占用 4 个字节，void* 占用不超过 8 个字节</li>
<li>sdshdr8 header 占用 3 个字节</li>
<li>字符串占用 44 个字节</li>
<li>结尾的空字符占用 1 个字节</li>
</ul>
<p>总计 4 + 4 + 8 + 3 + 44 + 1 = 64，所以可以使用 64 字节的连续空间来进行存储。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">define</span> OBJ_ENCODING_EMBSTR_SIZE_LIMIT 44</span></div><div class="line"><span class="function">robj *<span class="title">createStringObject</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *ptr, <span class="keyword">size_t</span> len)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (len &lt;= OBJ_ENCODING_EMBSTR_SIZE_LIMIT)</div><div class="line">        <span class="keyword">return</span> createEmbeddedStringObject(ptr,len);</div><div class="line">    <span class="keyword">else</span></div><div class="line">        <span class="keyword">return</span> createRawStringObject(ptr,len);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="列表对象"><a href="#列表对象" class="headerlink" title="列表对象"></a>列表对象</h3><p>在最新的 unstable 分值上，Redis 实现的列表对象的底层实现就是快速列表，而之前的版本中可以是压缩列表或者双端列表。之前用于判定压缩列表和双端链表的两个配置 list-max-ziplist-value 和 list-max-ziplist-entries 不再使用。<br>在前面对快速列表的介绍中可以知道，快速列表是一个节点为压缩列表的双端链表，因此，双端链表就是节点为单个元素的快速列表，而压缩列表就是只有一个节点的快速列表，使用一个单独的参数 list-max-ziplist-size 就可以进行控制。</p>
<h3 id="哈希对象"><a href="#哈希对象" class="headerlink" title="哈希对象"></a>哈希对象</h3><p>如果用压缩列表作为哈希对象的底层实现，那么会将键值对保存在压缩列表的相邻两个节点中，哈希键在前，哈希值在后，所有的键值对按照插入的顺序依次放入压缩列表中。<br>当以下两个条件同时满足时，使用压缩列表作为底层实现：</p>
<ul>
<li>保存的所有的字符串对象的长度都不大于 hash-max-ziplist-value 设定的值（默认为 64 字节）</li>
<li>保存的字符串对象的数量不大于 hash-max-ziplist-entries 设定的值（默认为 512）</li>
</ul>
<p>虽然用压缩列表实现的哈希对象在进行键值查询的时候需要通过遍历列表的方式进行查找，但是由于限制了数量，所以查找操作依旧是常数级的时间复杂度。而通过压缩列表的方式，可以节省存储空间。这里使用了用时间换空间的思想，即在对操作时间影响不大的情况下，尽量压缩存储空间，这个思想就是引入压缩列表最主要的动机，在有序集合对象的实现中也是同样的考虑。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">hashTypeTryConversion</span><span class="params">(robj *o, robj **argv, <span class="keyword">int</span> start, <span class="keyword">int</span> end)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> i;</div><div class="line">    <span class="keyword">if</span> (o-&gt;encoding != OBJ_ENCODING_ZIPLIST) <span class="keyword">return</span>;</div><div class="line">    <span class="keyword">for</span> (i = start; i &lt;= end; i++) &#123;</div><div class="line">        <span class="comment">// 这边只检查字符串的长度，时间复杂度为 O(1)</span></div><div class="line">        <span class="keyword">if</span> (sdsEncodedObject(argv[i]) &amp;&amp;</div><div class="line">            sdslen(argv[i]-&gt;ptr) &gt; server.hash_max_ziplist_value)</div><div class="line">        &#123;</div><div class="line">            hashTypeConvert(o, OBJ_ENCODING_HT);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">hashTypeSet</span><span class="params">(robj *o, sds field, sds value, <span class="keyword">int</span> flags)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> update = <span class="number">0</span>;</div><div class="line">    <span class="keyword">if</span> (o-&gt;encoding == OBJ_ENCODING_ZIPLIST) &#123;</div><div class="line">        <span class="keyword">unsigned</span> <span class="keyword">char</span> *zl, *fptr, *vptr;</div><div class="line">        zl = o-&gt;ptr;</div><div class="line">        fptr = ziplistIndex(zl, ZIPLIST_HEAD);</div><div class="line">        <span class="keyword">if</span> (fptr != <span class="literal">NULL</span>) &#123;</div><div class="line">            fptr = ziplistFind(fptr, (<span class="keyword">unsigned</span> <span class="keyword">char</span>*)field, sdslen(field), <span class="number">1</span>);</div><div class="line">            <span class="keyword">if</span> (fptr != <span class="literal">NULL</span>) &#123;</div><div class="line">                <span class="comment">/* Grab pointer to the value (fptr points to the field)</span></div><div class="line">                 *</div><div class="line">                 * 如果能找到对应的键，就更新对应的值</div><div class="line">                 */</div><div class="line">                vptr = ziplistNext(zl, fptr);</div><div class="line">                serverAssert(vptr != <span class="literal">NULL</span>);</div><div class="line">                update = <span class="number">1</span>;</div><div class="line">                <span class="comment">/* Delete value */</span></div><div class="line">                zl = ziplistDelete(zl, &amp;vptr);</div><div class="line">                <span class="comment">/* Insert new value */</span></div><div class="line">                zl = ziplistInsert(zl, vptr, (<span class="keyword">unsigned</span> <span class="keyword">char</span>*)value,</div><div class="line">                        sdslen(value));</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// 如果不是更新，则将对应的键值对插入表尾</span></div><div class="line">        <span class="keyword">if</span> (!update) &#123;</div><div class="line">            <span class="comment">/* Push new field/value pair onto the tail of the ziplist */</span></div><div class="line">            zl = ziplistPush(zl, (<span class="keyword">unsigned</span> <span class="keyword">char</span>*)field, sdslen(field),</div><div class="line">                    ZIPLIST_TAIL);</div><div class="line">            zl = ziplistPush(zl, (<span class="keyword">unsigned</span> <span class="keyword">char</span>*)value, sdslen(value),</div><div class="line">                    ZIPLIST_TAIL);</div><div class="line">        &#125;</div><div class="line">        o-&gt;ptr = zl;</div><div class="line">        <span class="comment">/* Check if the ziplist needs to be converted to a hash table</span></div><div class="line">         *</div><div class="line">         * 如果节点数超过 hash_max_ziplist_entries 设置的值，则需要转换成 hashtable，如果有必要的话</div><div class="line">         */</div><div class="line">        <span class="keyword">if</span> (hashTypeLength(o) &gt; server.hash_max_ziplist_entries)</div><div class="line">            hashTypeConvert(o, OBJ_ENCODING_HT);</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (o-&gt;encoding == OBJ_ENCODING_HT) &#123;</div><div class="line">        <span class="comment">// 查找键，如果存在，则进行更新，否则进行创建</span></div><div class="line">        dictEntry *de = dictFind(o-&gt;ptr,field);</div><div class="line">        <span class="keyword">if</span> (de) &#123;</div><div class="line">            sdsfree(dictGetVal(de));</div><div class="line">            <span class="keyword">if</span> (flags &amp; HASH_SET_TAKE_VALUE) &#123;</div><div class="line">                dictGetVal(de) = value;</div><div class="line">                value = <span class="literal">NULL</span>;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                dictGetVal(de) = sdsdup(value);</div><div class="line">            &#125;</div><div class="line">            update = <span class="number">1</span>;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            sds f,v;</div><div class="line">            <span class="keyword">if</span> (flags &amp; HASH_SET_TAKE_FIELD) &#123;</div><div class="line">                f = field;</div><div class="line">                field = <span class="literal">NULL</span>;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                f = sdsdup(field);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (flags &amp; HASH_SET_TAKE_VALUE) &#123;</div><div class="line">                v = value;</div><div class="line">                value = <span class="literal">NULL</span>;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                v = sdsdup(value);</div><div class="line">            &#125;</div><div class="line">            dictAdd(o-&gt;ptr,f,v);</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        serverPanic(<span class="string">"Unknown hash encoding"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">/* Free SDS strings we did not referenced elsewhere if the flags</span></div><div class="line">     * want this function to be responsible.</div><div class="line">     *</div><div class="line">     * 根据 flags 的设置选择性释放键值</div><div class="line">     */</div><div class="line">    <span class="keyword">if</span> (flags &amp; HASH_SET_TAKE_FIELD &amp;&amp; field) sdsfree(field);</div><div class="line">    <span class="keyword">if</span> (flags &amp; HASH_SET_TAKE_VALUE &amp;&amp; value) sdsfree(value);</div><div class="line">    <span class="keyword">return</span> update;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="集合对象"><a href="#集合对象" class="headerlink" title="集合对象"></a>集合对象</h3><p>当以下两个条件同时满足时，使用整数集合作为底层实现：</p>
<ol>
<li>保存的所有元素都是整数</li>
<li>保存的数量不超过 set-max-intset-entries 设置的值（默认为 512）</li>
</ol>
<p>在使用哈希表作为底层实现时，所有的集合元素都作为哈希键保存，而对应的哈希值则设置为 NULL。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">setTypeAdd</span><span class="params">(robj *subject, sds value)</span> </span>&#123;</div><div class="line">    <span class="keyword">long</span> <span class="keyword">long</span> llval;</div><div class="line">    <span class="keyword">if</span> (subject-&gt;encoding == OBJ_ENCODING_HT) &#123;</div><div class="line">        dict *ht = subject-&gt;ptr;</div><div class="line">        <span class="comment">// 如果已经存在，dictAddRaw 返回的是 NULL，跳过处理</span></div><div class="line">        <span class="comment">// 否则将 value 作为键存入，值设为 NULL</span></div><div class="line">        dictEntry *de = dictAddRaw(ht,value,<span class="literal">NULL</span>);</div><div class="line">        <span class="keyword">if</span> (de) &#123;</div><div class="line">            dictSetKey(ht,de,sdsdup(value));</div><div class="line">            dictSetVal(ht,de,<span class="literal">NULL</span>);</div><div class="line">            <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (subject-&gt;encoding == OBJ_ENCODING_INTSET) &#123;</div><div class="line">        <span class="comment">// 判断是否是整数值，如果是，则插入，否则的话，需要把 intset 换成 hashtable</span></div><div class="line">        <span class="keyword">if</span> (isSdsRepresentableAsLongLong(value,&amp;llval) == C_OK) &#123;</div><div class="line">            <span class="keyword">uint8_t</span> success = <span class="number">0</span>;</div><div class="line">            subject-&gt;ptr = intsetAdd(subject-&gt;ptr,llval,&amp;success);</div><div class="line">            <span class="keyword">if</span> (success) &#123;</div><div class="line">                <span class="comment">/* Convert to regular set when the intset contains</span></div><div class="line">                 * too many entries.</div><div class="line">                 *</div><div class="line">                 * 如果节点数过多，则将 intset 转成 hashtable</div><div class="line">                 */</div><div class="line">                <span class="keyword">if</span> (intsetLen(subject-&gt;ptr) &gt; server.set_max_intset_entries)</div><div class="line">                    setTypeConvert(subject,OBJ_ENCODING_HT);</div><div class="line">                <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">/* Failed to get integer from object, convert to regular set. */</span></div><div class="line">            setTypeConvert(subject,OBJ_ENCODING_HT);</div><div class="line">            <span class="comment">/* The set *was* an intset and this value is not integer</span></div><div class="line">             * encodable, so dictAdd should always work. */</div><div class="line">            serverAssert(dictAdd(subject-&gt;ptr,sdsdup(value),<span class="literal">NULL</span>) == DICT_OK);</div><div class="line">            <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        serverPanic(<span class="string">"Unknown set encoding"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="有序集合对象"><a href="#有序集合对象" class="headerlink" title="有序集合对象"></a>有序集合对象</h3><p>有序集合对象的底层实现可以是压缩列表，也可以是跳跃表。当以下两个条件同时满足时，使用压缩列表作为底层实现：</p>
<ul>
<li>保存的所有的字符串对象的长度都不大于 zset-max-ziplist-value 设定的值（默认为 64 字节）</li>
<li>保存的字符串对象的数量不大于 zset-max-ziplist-entries 设定的值（默认为 512）<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">zsetConvertToZiplistIfNeeded</span><span class="params">(robj *zobj, <span class="keyword">size_t</span> maxelelen)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (zobj-&gt;encoding == OBJ_ENCODING_ZIPLIST) <span class="keyword">return</span>;</div><div class="line">    zset *zset = zobj-&gt;ptr;</div><div class="line">    <span class="keyword">if</span> (zset-&gt;zsl-&gt;length &lt;= server.zset_max_ziplist_entries &amp;&amp;</div><div class="line">        maxelelen &lt;= server.zset_max_ziplist_value)</div><div class="line">            zsetConvert(zobj,OBJ_ENCODING_ZIPLIST);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>当底层实现是压缩列表时，用连续的两个压缩列表的节点来保存有序集合的元素和分值，元素在前，分值在后。同时，所有的元素在压缩列表中，按照分值的大小从小到大保存在压缩列表中，因此需要找到合适的位置将新的元素插入。这样的插入操作可能会引发链式更新后续节点的操作，但是由于压缩列表中的节点数量是有限的，因此时间复杂度并不会变得特别糟糕。<br>当底层实现是跳跃表时，Redis 封装了一个新的数据结构 zset 来作为实现，包含了一个哈希表和一个跳跃表：</p>
<ul>
<li>哈希表的键为成员，值为分值，这样能用 O(1) 的时间复杂度取出对应的分值</li>
<li>而跳跃表按照分值排序成员，用于支持平均复杂度为 O(log N) 的按分值定位成员操作，以及范围操作</li>
</ul>
<p>通过空间换时间的方式，可以使得有序集合对象的各项操作的时间复杂度都维持在一个较低的水平上。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">zset</span> &#123;</span></div><div class="line">    <span class="comment">// 字典，键为成员，值为分值，用于支持 O(1) 复杂度的按成员取分值操作</span></div><div class="line">    dict *dict;</div><div class="line">    <span class="comment">// 跳跃表，按分值排序成员，用于支持平均复杂度为 O(log N) 的按分值定位成员操作，以及范围操作</span></div><div class="line">    zskiplist *zsl;</div><div class="line">&#125; zset;</div></pre></td></tr></table></figure>
<p>注意，在给 zset 添加元素的时候，会进行 ziplist 到 skiplist 的转换条件判断，但是删除元素的时候并不会进行反向的判断。Redis 只有在进行 rdb 文件处理时，才会进行反向的判断。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">zsetAdd</span><span class="params">(robj *zobj, <span class="keyword">double</span> score, sds ele, <span class="keyword">int</span> *flags, <span class="keyword">double</span> *newscore)</span> </span>&#123;</div><div class="line">    <span class="comment">/* Turn options into simple to check vars. */</span></div><div class="line">    <span class="keyword">int</span> incr = (*flags &amp; ZADD_INCR) != <span class="number">0</span>;</div><div class="line">    <span class="keyword">int</span> nx = (*flags &amp; ZADD_NX) != <span class="number">0</span>;</div><div class="line">    <span class="keyword">int</span> xx = (*flags &amp; ZADD_XX) != <span class="number">0</span>;</div><div class="line">    *flags = <span class="number">0</span>; <span class="comment">/* We'll return our response flags. */</span></div><div class="line">    <span class="keyword">double</span> curscore;</div><div class="line">    <span class="comment">/* NaN as input is an error regardless of all the other parameters.</span></div><div class="line">     *</div><div class="line">     * 如果分值非数值型，直接返回</div><div class="line">     */</div><div class="line">    <span class="keyword">if</span> (isnan(score)) &#123;</div><div class="line">        *flags = ZADD_NAN;</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">/* Update the sorted set according to its encoding. */</span></div><div class="line">    <span class="keyword">if</span> (zobj-&gt;encoding == OBJ_ENCODING_ZIPLIST) &#123;</div><div class="line">        <span class="keyword">unsigned</span> <span class="keyword">char</span> *eptr;</div><div class="line">        <span class="keyword">if</span> ((eptr = zzlFind(zobj-&gt;ptr,ele,&amp;curscore)) != <span class="literal">NULL</span>) &#123;</div><div class="line">            <span class="comment">/* NX? Return, same element already exists.</span></div><div class="line">             *</div><div class="line">             * ZADD_NX 被设置，所以直接不操作，返回</div><div class="line">             */</div><div class="line">            <span class="keyword">if</span> (nx) &#123;</div><div class="line">                *flags |= ZADD_NOP;</div><div class="line">                <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="comment">/* Prepare the score for the increment if needed.</span></div><div class="line">             *</div><div class="line">             * 计算新的分值</div><div class="line">             */</div><div class="line">            <span class="keyword">if</span> (incr) &#123;</div><div class="line">                score += curscore;</div><div class="line">                <span class="keyword">if</span> (isnan(score)) &#123;</div><div class="line">                    *flags |= ZADD_NAN;</div><div class="line">                    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (newscore) *newscore = score;</div><div class="line">            &#125;</div><div class="line">            <span class="comment">/* Remove and re-insert when score changed.</span></div><div class="line">             *</div><div class="line">             * 执行到这里，说明 ZADD_NX 没有被设置，所以直接替换原有的元素</div><div class="line">             */</div><div class="line">            <span class="keyword">if</span> (score != curscore) &#123;</div><div class="line">                zobj-&gt;ptr = zzlDelete(zobj-&gt;ptr,eptr);</div><div class="line">                zobj-&gt;ptr = zzlInsert(zobj-&gt;ptr,ele,score);</div><div class="line">                *flags |= ZADD_UPDATED;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!xx) &#123;</div><div class="line">            <span class="comment">/* Optimize: check if the element is too large or the list</span></div><div class="line">             * becomes too long *before* executing zzlInsert.</div><div class="line">             *</div><div class="line">             * 在这个分支里，元素原先不存在，这个时候需要插入新元素</div><div class="line">             * 这个操作可能导致元素个数过多，或者元素大小过大，使得 zset 的编码由 ziplist 变为 skiplist</div><div class="line">             */</div><div class="line">            zobj-&gt;ptr = zzlInsert(zobj-&gt;ptr,ele,score);</div><div class="line">            <span class="keyword">if</span> (zzlLength(zobj-&gt;ptr) &gt; server.zset_max_ziplist_entries)</div><div class="line">                zsetConvert(zobj,OBJ_ENCODING_SKIPLIST);</div><div class="line">            <span class="keyword">if</span> (sdslen(ele) &gt; server.zset_max_ziplist_value)</div><div class="line">                zsetConvert(zobj,OBJ_ENCODING_SKIPLIST);</div><div class="line">            <span class="keyword">if</span> (newscore) *newscore = score;</div><div class="line">            *flags |= ZADD_ADDED;</div><div class="line">            <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">// ZADD_XX 被设置，所以直接不操作，返回</span></div><div class="line">            *flags |= ZADD_NOP;</div><div class="line">            <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (zobj-&gt;encoding == OBJ_ENCODING_SKIPLIST) &#123;</div><div class="line">        zset *zs = zobj-&gt;ptr;</div><div class="line">        zskiplistNode *znode;</div><div class="line">        dictEntry *de;</div><div class="line">        de = dictFind(zs-&gt;dict,ele);</div><div class="line">        <span class="keyword">if</span> (de != <span class="literal">NULL</span>) &#123;</div><div class="line">            <span class="comment">/* NX? Return, same element already exists.</span></div><div class="line">             *</div><div class="line">             * ZADD_NX 被设置，所以直接不操作，返回</div><div class="line">             */</div><div class="line">            <span class="keyword">if</span> (nx) &#123;</div><div class="line">                *flags |= ZADD_NOP;</div><div class="line">                <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">            &#125;</div><div class="line">            curscore = *(<span class="keyword">double</span>*)dictGetVal(de);</div><div class="line">            <span class="comment">/* Prepare the score for the increment if needed.</span></div><div class="line">             *</div><div class="line">             * 计算新的分值</div><div class="line">             */</div><div class="line">            <span class="keyword">if</span> (incr) &#123;</div><div class="line">                score += curscore;</div><div class="line">                <span class="keyword">if</span> (isnan(score)) &#123;</div><div class="line">                    *flags |= ZADD_NAN;</div><div class="line">                    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (newscore) *newscore = score;</div><div class="line">            &#125;</div><div class="line">            <span class="comment">/* Remove and re-insert when score changes.</span></div><div class="line">             *</div><div class="line">             * 执行到这里，说明 ZADD_NX 没有被设置，所以直接替换原有的元素</div><div class="line">             */</div><div class="line">            <span class="keyword">if</span> (score != curscore) &#123;</div><div class="line">                zskiplistNode *node;</div><div class="line">                serverAssert(zslDelete(zs-&gt;zsl,curscore,ele,&amp;node));</div><div class="line">                znode = zslInsert(zs-&gt;zsl,score,node-&gt;ele);</div><div class="line">                <span class="comment">/* We reused the node-&gt;ele SDS string, free the node now</span></div><div class="line">                 * since zslInsert created a new one.</div><div class="line">                 *</div><div class="line">                 * 在 zslInsert 中，为元素新建了一个 SDS，所以这边可以将老的节点释放掉</div><div class="line">                 */</div><div class="line">                node-&gt;ele = <span class="literal">NULL</span>;</div><div class="line">                zslFreeNode(node);</div><div class="line">                <span class="comment">/* Note that we did not removed the original element from</span></div><div class="line">                 * the hash table representing the sorted set, so we just</div><div class="line">                 * update the score. */</div><div class="line">                dictGetVal(de) = &amp;znode-&gt;score; <span class="comment">/* Update score ptr. */</span></div><div class="line">                *flags |= ZADD_UPDATED;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!xx) &#123;</div><div class="line">            <span class="comment">/*</span></div><div class="line">             * 这里直接添加新的元素，注意，这里不做从 skiplist 到 ziplist 的判断</div><div class="line">             * 因为从 ziplist 转换成 skiplist，说明至少一个条件不满足，而这边并不会使不满足的条件重新被满足</div><div class="line">             */</div><div class="line">            ele = sdsdup(ele);</div><div class="line">            znode = zslInsert(zs-&gt;zsl,score,ele);</div><div class="line">            serverAssert(dictAdd(zs-&gt;dict,ele,&amp;znode-&gt;score) == DICT_OK);</div><div class="line">            *flags |= ZADD_ADDED;</div><div class="line">            <span class="keyword">if</span> (newscore) *newscore = score;</div><div class="line">            <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">// ZADD_XX 被设置，所以直接不操作，返回</span></div><div class="line">            *flags |= ZADD_NOP;</div><div class="line">            <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        serverPanic(<span class="string">"Unknown sorted set encoding"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">/* Never reached. */</span></div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">zsetDel</span><span class="params">(robj *zobj, sds ele)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (zobj-&gt;encoding == OBJ_ENCODING_ZIPLIST) &#123;</div><div class="line">        <span class="keyword">unsigned</span> <span class="keyword">char</span> *eptr;</div><div class="line">        <span class="keyword">if</span> ((eptr = zzlFind(zobj-&gt;ptr,ele,<span class="literal">NULL</span>)) != <span class="literal">NULL</span>) &#123;</div><div class="line">            zobj-&gt;ptr = zzlDelete(zobj-&gt;ptr,eptr);</div><div class="line">            <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (zobj-&gt;encoding == OBJ_ENCODING_SKIPLIST) &#123;</div><div class="line">        zset *zs = zobj-&gt;ptr;</div><div class="line">        dictEntry *de;</div><div class="line">        <span class="keyword">double</span> score;</div><div class="line">        <span class="comment">// 这边没有从字典中立刻删除是因为还要获取分值</span></div><div class="line">        de = dictUnlink(zs-&gt;dict,ele);</div><div class="line">        <span class="keyword">if</span> (de != <span class="literal">NULL</span>) &#123;</div><div class="line">            <span class="comment">/* Get the score in order to delete from the skiplist later. */</span></div><div class="line">            score = *(<span class="keyword">double</span>*)dictGetVal(de);</div><div class="line">            <span class="comment">/* Delete from the hash table and later from the skiplist.</span></div><div class="line">             * Note that the order is important: deleting from the skiplist</div><div class="line">             * actually releases the SDS string representing the element,</div><div class="line">             * which is shared between the skiplist and the hash table, so</div><div class="line">             * we need to delete from the skiplist as the final step.</div><div class="line">             *</div><div class="line">             * 注意：一定要先从 dict 中删除以后，再从 skiplist 中删除</div><div class="line">             * 因为在 skiplist 中删除节点，会将 ele 也进行释放</div><div class="line">             */</div><div class="line">            dictFreeUnlinkedEntry(zs-&gt;dict,de);</div><div class="line">            <span class="comment">/* Delete from skiplist.</span></div><div class="line">             *</div><div class="line">             * 从 skiplist 中删除对应的元素</div><div class="line">             */</div><div class="line">            <span class="keyword">int</span> retval = zslDelete(zs-&gt;zsl,score,ele,<span class="literal">NULL</span>);</div><div class="line">            serverAssert(retval);</div><div class="line">            <span class="keyword">if</span> (htNeedsResize(zs-&gt;dict)) dictResize(zs-&gt;dict);</div><div class="line">            <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        serverPanic(<span class="string">"Unknown sorted set encoding"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">/* No such element found. */</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/11/22/redis_quick_list/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="柿子">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="柿子的果盘">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/11/22/redis_quick_list/" itemprop="url">Redis数据结构: 快速列表</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-11-22T00:00:00+08:00">
                2016-11-22
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/开源项目/" itemprop="url" rel="index">
                    <span itemprop="name">开源项目</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2016/11/22/redis_quick_list/" class="leancloud_visitors" data-flag-title="Redis数据结构: 快速列表">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在前面对于压缩列表的介绍中，我们可以知道压缩列表的一些缺点，如查找操作需要 O(N) 的时间复杂度（即使有对应节点的索引值），数据变动的时候可能会引发连锁的更新，这些缺点决定了压缩列表无法用于大规模的数据。而快速列表的设计，则一定程度上克服了这些缺点，在空间利用率和时间复杂度上取得一个平衡。</p>
<p>快速列表的本质是一个双端链表，它的每一个节点都是压缩列表。这样的设计好处是：</p>
<ul>
<li>可以通过限制压缩列表的节点数和长度，使得双端链表的每个节点对应的压缩列表不会太大，避免更新数据产生 realloc 时需要大量的数据拷贝；</li>
<li>使用压缩列表作为节点，可以使得连续的节点的存储在同一段内存空间中，减少内存碎片，同时提高存储效率；</li>
<li>由于压缩列表中记录了节点数，所以在使用索引进行查找时，可以比单纯使用双端链表或压缩列表更快。</li>
</ul>
<p>此外，由于 Redis 频繁地在快速列表的两端进行操作，而中间的节点比较少被使用到，因此，使用 LZF 压缩算法对中间的压缩列表进行压缩能够进一步地节省空间。</p>
<h3 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h3><p>quicklist.h 中定义了快速列表的节点结构，包含了：</p>
<ul>
<li>prev、next：前驱节点和后继节点的指针</li>
<li>zl：指向压缩列表的指针</li>
<li>sz：压缩列表中的字节数，包括了 zlbytes、zltail、zllen、zlend 和各个数据项，此外，即使压缩列表被压缩了，这边表示的依旧是压缩前的字节数<br>各类标记，这里使用了一个 C 语言的语法，unsigned int count : 16 表示使用 16 个 bit 来存储 count 变量，因此使用了 32 bit（即 2 个字节）来存储这些标记，包括：<ul>
<li>count（16 bits）：压缩列表包含的数据项</li>
<li>encoding（2 bits）：表示是否压缩过，未压缩则是 1，压缩过的则是 2</li>
<li>container（2 bits）：预留字段，当前是固定值 2</li>
<li>recompress（1 bit）：置为 1 的时候表示需要将压缩列表重新压缩，由于在遍历的时候，需要把压缩的节点解压后使用，所以解压后设置标志位，以便后面再进行压缩</li>
<li>attempted_compress（1 bit）：测试时用的字段，表示不需要进行压缩</li>
<li>extra（10 bits）：还未用上的预留空间</li>
</ul>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">quicklistNode</span> &#123;</span></div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">quicklistNode</span> *<span class="title">prev</span>;</span></div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">quicklistNode</span> *<span class="title">next</span>;</span></div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *zl;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> sz;             <span class="comment">/* ziplist size in bytes */</span></div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> count : <span class="number">16</span>;     <span class="comment">/* count of items in ziplist */</span></div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> encoding : <span class="number">2</span>;   <span class="comment">/* RAW==1 or LZF==2 */</span></div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> container : <span class="number">2</span>;  <span class="comment">/* NONE==1 or ZIPLIST==2 */</span></div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> recompress : <span class="number">1</span>; <span class="comment">/* was this node previous compressed? */</span></div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> attempted_compress : <span class="number">1</span>; <span class="comment">/* node can't compress; too small */</span></div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> extra : <span class="number">10</span>; <span class="comment">/* more bits to steal for future usage */</span></div><div class="line">&#125; quicklistNode;</div></pre></td></tr></table></figure>
<p>quicklistLZF 表示了一个被压缩的节点结构，其中：</p>
<ul>
<li>sz：表示压缩以后压缩列表的字节数</li>
<li>compressed：存放压缩后的压缩列表的字节数组，与 SDS 的 buf 一样，这是一个柔性数组。</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">quicklistLZF</span> &#123;</span></div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> sz; <span class="comment">/* LZF size in bytes*/</span></div><div class="line">    <span class="keyword">char</span> compressed[];</div><div class="line">&#125; quicklistLZF;</div></pre></td></tr></table></figure>
<p>快速列表的结构则包括：</p>
<ul>
<li>head、tail：列表表头和表尾指针</li>
<li>count：所有的压缩列表的节点数总和</li>
<li>len：快速列表的节点数</li>
<li>32 位的标记：<ul>
<li>fill（16 bits）：ziplist 大小设置，存放 list-max-ziplist-size 参数的值<br>若为负数，则表示ziplist的最大字节数，取值为 -1（4 Kb），-2（8 Kb），-3（16 Kb），-4（32 Kb），-5（64 Kb）<br>若为正数，则表示ziplist的最大节点数，最大为 8192（2^13）</li>
<li>compress（16 bits）：节点压缩深度设置，存放 list-compress-depth 参数的值，表示前后各有几个节点不压缩，0 是个特殊值，表示所有节点都不压缩，这是 Redis 的默认值</li>
</ul>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">quicklist</span> &#123;</span></div><div class="line">    quicklistNode *head;</div><div class="line">    quicklistNode *tail;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> count;        <span class="comment">/* total count of all entries in all ziplists */</span></div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> len;           <span class="comment">/* number of quicklistNodes */</span></div><div class="line">    <span class="keyword">int</span> fill : <span class="number">16</span>;              <span class="comment">/* fill factor for individual nodes */</span></div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> compress : <span class="number">16</span>; <span class="comment">/* depth of end nodes not to compress;0=off */</span></div><div class="line">&#125; quicklist;</div></pre></td></tr></table></figure>
<p>快速列表中 fill 属性的设置是为了使存储效率和时间复杂度达到一个平衡：</p>
<ul>
<li>如果压缩列表的节点数太多，则会导致分配连续内存空间的难度加大，同时更新节点数据操作造成大量数据拷贝的风险加大；</li>
<li>如果压缩列表的节点数太少，则会使快速列表退化成双端链表，存储效率低，内存空间随便多。</li>
</ul>
<p>根据使用的场景不同，可以对应地设置限定压缩列表的字节数（每个节点需要的存储空间较大时）或节点数（每个节点需要的存储空间较小时），同时这个参数的设置，也影响了 quicklistNode 结构中的 count 的位数：</p>
<ul>
<li>若这个参数取正值时，压缩列表的最大个数被限定在 2^15（实际上限制为 8192，即 2^13），可以使用 16 bits 进行存储；</li>
<li>若这个参数取负值时，压缩列表的最大字节数是 64 K，由于每一个节点至少占用 2 个字节，因此最大的数量为 32 K，也可以使用 16 bits 进行存储。</li>
</ul>
<p>而 compress 属性的设置主要是由于快速列表的使用场景是针对列表两端的节点进行频繁操作，而对于列表中间的节点进行操作的频率很低，这样压缩中间的节点，可以节省空间，而两端的节点不压缩则方便操作。</p>
<h3 id="压缩列表大小的判定"><a href="#压缩列表大小的判定" class="headerlink" title="压缩列表大小的判定"></a>压缩列表大小的判定</h3><p>由于快速列表设计的关键是压缩列表的大小限定，通过列表结构中的 fill 属性进行约束，因此在进行压缩列表新节点的插入，或者两个压缩列表的合并时，需要判定是否满足 fill 定义的限制条件，具体代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div></pre></td><td class="code"><pre><div class="line">REDIS_STATIC <span class="keyword">int</span> _quicklistNodeAllowInsert(<span class="keyword">const</span> quicklistNode *node,</div><div class="line">                                           <span class="keyword">const</span> <span class="keyword">int</span> fill, <span class="keyword">const</span> <span class="keyword">size_t</span> sz) &#123;</div><div class="line">    <span class="keyword">if</span> (unlikely(!node))</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    <span class="keyword">int</span> ziplist_overhead;</div><div class="line">    <span class="comment">/* size of previous offset</span></div><div class="line">     *</div><div class="line">     * 判断 header 占用的字节数</div><div class="line">     */</div><div class="line">    <span class="keyword">if</span> (sz &lt; <span class="number">254</span>)</div><div class="line">        ziplist_overhead = <span class="number">1</span>;</div><div class="line">    <span class="keyword">else</span></div><div class="line">        ziplist_overhead = <span class="number">5</span>;</div><div class="line">    <span class="comment">/* size of forward offset</span></div><div class="line">     *</div><div class="line">     * 判断 encoding 占用的字节数</div><div class="line">     */</div><div class="line">    <span class="keyword">if</span> (sz &lt; <span class="number">64</span>)</div><div class="line">        ziplist_overhead += <span class="number">1</span>;</div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (likely(sz &lt; <span class="number">16384</span>))</div><div class="line">        ziplist_overhead += <span class="number">2</span>;</div><div class="line">    <span class="keyword">else</span></div><div class="line">        ziplist_overhead += <span class="number">5</span>;</div><div class="line">    <span class="comment">/* new_sz overestimates if 'sz' encodes to an integer type</span></div><div class="line">     *</div><div class="line">     * 当新节点存入的是整型数时，这边会过高估计使用的字节数</div><div class="line">     */</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> new_sz = node-&gt;sz + sz + ziplist_overhead;</div><div class="line">    <span class="comment">// 首先判断字节数是否满足要求，若 fill &gt; 0，则表示对字节数没有限制，只对数量进行限制</span></div><div class="line">    <span class="keyword">if</span> (likely(_quicklistNodeSizeMeetsOptimizationRequirement(new_sz, fill)))</div><div class="line">        <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!sizeMeetsSafetyLimit(new_sz))</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    <span class="comment">// 若到这里进行判断，则要么是字节数不满足限制（这种情况下 fill 为负数，这边也肯定不满足要求）</span></div><div class="line">    <span class="comment">// 要么是字节数没有限制，而节点数有限制，此时 fill 为正数</span></div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ((<span class="keyword">int</span>)node-&gt;count &lt; fill)</div><div class="line">        <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">    <span class="keyword">else</span></div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line">REDIS_STATIC <span class="keyword">int</span> _quicklistNodeAllowMerge(<span class="keyword">const</span> quicklistNode *a,</div><div class="line">                                          <span class="keyword">const</span> quicklistNode *b,</div><div class="line">                                          <span class="keyword">const</span> <span class="keyword">int</span> fill) &#123;</div><div class="line">    <span class="keyword">if</span> (!a || !b)</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    <span class="comment">/* approximate merged ziplist size (- 11 to remove one ziplist</span></div><div class="line">     * header/trailer)</div><div class="line">     *</div><div class="line">     * 11 是 header 和 tail 的大小，合并以后只需要一个 header 和一个 tail</div><div class="line">     */</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> merge_sz = a-&gt;sz + b-&gt;sz - <span class="number">11</span>;</div><div class="line">    <span class="comment">// 首先判断字节数是否满足条件</span></div><div class="line">    <span class="keyword">if</span> (likely(_quicklistNodeSizeMeetsOptimizationRequirement(merge_sz, fill)))</div><div class="line">        <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">    <span class="comment">// 其次判断是否满足最大字节数的条件</span></div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!sizeMeetsSafetyLimit(merge_sz))</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    <span class="comment">// 判断节点数是否满足条件</span></div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ((<span class="keyword">int</span>)(a-&gt;count + b-&gt;count) &lt;= fill)</div><div class="line">        <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">    <span class="keyword">else</span></div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Push-和-Pop-操作"><a href="#Push-和-Pop-操作" class="headerlink" title="Push 和 Pop 操作"></a>Push 和 Pop 操作</h3><p>如前所述，快速列表的操作经常在两端进行，因此定义了 Push 和 Pop 两个操作。<br>在进行 Push 操作的时候，需要判断表头节点（或表尾节点）是否有足够的空间（满足 fill 属性）可以存储新的节点。若可以存储，则直接存入，否则需要新建一个快速列表节点（即压缩列表）进行存储。具体代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">quicklistPushHead</span><span class="params">(quicklist *quicklist, <span class="keyword">void</span> *value, <span class="keyword">size_t</span> sz)</span> </span>&#123;</div><div class="line">    quicklistNode *orig_head = quicklist-&gt;head;</div><div class="line">    <span class="keyword">if</span> (likely(</div><div class="line">            _quicklistNodeAllowInsert(quicklist-&gt;head, quicklist-&gt;fill, sz))) &#123;</div><div class="line">        quicklist-&gt;head-&gt;zl =</div><div class="line">            ziplistPush(quicklist-&gt;head-&gt;zl, value, sz, ZIPLIST_HEAD);</div><div class="line">        quicklistNodeUpdateSz(quicklist-&gt;head);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        quicklistNode *node = quicklistCreateNode();</div><div class="line">        node-&gt;zl = ziplistPush(ziplistNew(), value, sz, ZIPLIST_HEAD);</div><div class="line">        quicklistNodeUpdateSz(node);</div><div class="line">        _quicklistInsertNodeBefore(quicklist, quicklist-&gt;head, node);</div><div class="line">    &#125;</div><div class="line">    quicklist-&gt;count++;</div><div class="line">    quicklist-&gt;head-&gt;count++;</div><div class="line">    <span class="keyword">return</span> (orig_head != quicklist-&gt;head);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">quicklistPushTail</span><span class="params">(quicklist *quicklist, <span class="keyword">void</span> *value, <span class="keyword">size_t</span> sz)</span> </span>&#123;</div><div class="line">    quicklistNode *orig_tail = quicklist-&gt;tail;</div><div class="line">    <span class="keyword">if</span> (likely(</div><div class="line">            _quicklistNodeAllowInsert(quicklist-&gt;tail, quicklist-&gt;fill, sz))) &#123;</div><div class="line">        quicklist-&gt;tail-&gt;zl =</div><div class="line">            ziplistPush(quicklist-&gt;tail-&gt;zl, value, sz, ZIPLIST_TAIL);</div><div class="line">        quicklistNodeUpdateSz(quicklist-&gt;tail);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        quicklistNode *node = quicklistCreateNode();</div><div class="line">        node-&gt;zl = ziplistPush(ziplistNew(), value, sz, ZIPLIST_TAIL);</div><div class="line">        quicklistNodeUpdateSz(node);</div><div class="line">        _quicklistInsertNodeAfter(quicklist, quicklist-&gt;tail, node);</div><div class="line">    &#125;</div><div class="line">    quicklist-&gt;count++;</div><div class="line">    quicklist-&gt;tail-&gt;count++;</div><div class="line">    <span class="keyword">return</span> (orig_tail != quicklist-&gt;tail);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">quicklistPush</span><span class="params">(quicklist *quicklist, <span class="keyword">void</span> *value, <span class="keyword">const</span> <span class="keyword">size_t</span> sz,</span></span></div><div class="line">                   <span class="keyword">int</span> where) &#123;</div><div class="line">    <span class="keyword">if</span> (where == QUICKLIST_HEAD) &#123;</div><div class="line">        quicklistPushHead(quicklist, value, sz);</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (where == QUICKLIST_TAIL) &#123;</div><div class="line">        quicklistPushTail(quicklist, value, sz);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在进行 Pop 操作的时候，需要根据传入的 saver 函数将取出的节点内容保存在对应的指针中：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div></pre></td><td class="code"><pre><div class="line">int quicklistPopCustom(quicklist *quicklist, int where, unsigned char **data,</div><div class="line">                       unsigned int *sz, long long *sval,</div><div class="line">                       void *(*saver)(unsigned char *data, unsigned int sz)) &#123;</div><div class="line">    unsigned char *p;</div><div class="line">    unsigned char *vstr;</div><div class="line">    unsigned int vlen;</div><div class="line">    long long vlong;</div><div class="line">    int pos = (where == QUICKLIST_HEAD) ? 0 : -1;</div><div class="line">    if (quicklist-&gt;count == 0)</div><div class="line">        return 0;</div><div class="line">    if (data)</div><div class="line">        *data = NULL;</div><div class="line">    if (sz)</div><div class="line">        *sz = 0;</div><div class="line">    if (sval)</div><div class="line">        *sval = -123456789;</div><div class="line">    quicklistNode *node;</div><div class="line">    if (where == QUICKLIST_HEAD &amp;&amp; quicklist-&gt;head) &#123;</div><div class="line">        node = quicklist-&gt;head;</div><div class="line">    &#125; else if (where == QUICKLIST_TAIL &amp;&amp; quicklist-&gt;tail) &#123;</div><div class="line">        node = quicklist-&gt;tail;</div><div class="line">    &#125; else &#123;</div><div class="line">        return 0;</div><div class="line">    &#125;</div><div class="line">    // 取出对应的节点</div><div class="line">    p = ziplistIndex(node-&gt;zl, pos);</div><div class="line">    if (ziplistGet(p, &amp;vstr, &amp;vlen, &amp;vlong)) &#123;</div><div class="line">        if (vstr) &#123;</div><div class="line">            if (data)</div><div class="line">                *data = saver(vstr, vlen);</div><div class="line">            if (sz)</div><div class="line">                *sz = vlen;</div><div class="line">        &#125; else &#123;</div><div class="line">            if (data)</div><div class="line">                *data = NULL;</div><div class="line">            if (sval)</div><div class="line">                *sval = vlong;</div><div class="line">        &#125;</div><div class="line">        quicklistDelIndex(quicklist, node, &amp;p);</div><div class="line">        return 1;</div><div class="line">    &#125;</div><div class="line">    return 0;</div><div class="line">&#125;</div><div class="line">REDIS_STATIC void *_quicklistSaver(unsigned char *data, unsigned int sz) &#123;</div><div class="line">    unsigned char *vstr;</div><div class="line">    if (data) &#123;</div><div class="line">        vstr = zmalloc(sz);</div><div class="line">        memcpy(vstr, data, sz);</div><div class="line">        return vstr;</div><div class="line">    &#125;</div><div class="line">    return NULL;</div><div class="line">&#125;</div><div class="line">int quicklistPop(quicklist *quicklist, int where, unsigned char **data,</div><div class="line">                 unsigned int *sz, long long *slong) &#123;</div><div class="line">    unsigned char *vstr;</div><div class="line">    unsigned int vlen;</div><div class="line">    long long vlong;</div><div class="line">    if (quicklist-&gt;count == 0)</div><div class="line">        return 0;</div><div class="line">    int ret = quicklistPopCustom(quicklist, where, &amp;vstr, &amp;vlen, &amp;vlong,</div><div class="line">                                 _quicklistSaver);</div><div class="line">    if (data)</div><div class="line">        *data = vstr;</div><div class="line">    if (slong)</div><div class="line">        *slong = vlong;</div><div class="line">    if (sz)</div><div class="line">        *sz = vlen;</div><div class="line">    return ret;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="任意位置的插入"><a href="#任意位置的插入" class="headerlink" title="任意位置的插入"></a>任意位置的插入</h3><p>除了从头部或尾部插入，快速列表还实现了从任意指定的位置插入，这时候由于需要满足 fill 设定的压缩列表大小，会将逻辑分为如下几种情况：</p>
<ul>
<li>若当前的压缩列表有空间可以存入新的节点，则直接存入；</li>
<li>若当前的压缩列表没有空间，且插入位置在表头或表尾，则考虑前一个或后一个压缩列表是否有空间存储：<ul>
<li>若有空间，则直接存入；</li>
<li>否则，新建一个快速列表的节点，将其插入对应的位置，用于存储新节点；</li>
</ul>
</li>
<li>若当前的压缩列表没有空间，且插入位置不在表头或表尾，则需要将当前的压缩列表拆分以后，插入合适的压缩列表。</li>
</ul>
<p>具体代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div></pre></td><td class="code"><pre><div class="line">REDIS_STATIC <span class="keyword">void</span> _quicklistInsert(quicklist *quicklist, quicklistEntry *entry,</div><div class="line">                                   <span class="keyword">void</span> *value, <span class="keyword">const</span> <span class="keyword">size_t</span> sz, <span class="keyword">int</span> after) &#123;</div><div class="line">    <span class="keyword">int</span> full = <span class="number">0</span>, at_tail = <span class="number">0</span>, at_head = <span class="number">0</span>, full_next = <span class="number">0</span>, full_prev = <span class="number">0</span>;</div><div class="line">    <span class="keyword">int</span> fill = quicklist-&gt;fill;</div><div class="line">    quicklistNode *node = entry-&gt;node;</div><div class="line">    quicklistNode *new_node = <span class="literal">NULL</span>;</div><div class="line">    <span class="keyword">if</span> (!node) &#123;</div><div class="line">        <span class="comment">/* we have no reference node, so let's create only node in the list</span></div><div class="line">         *</div><div class="line">         * 若没有指定快速列表的节点，则新建一个节点用于存储压缩列表节点</div><div class="line">         */</div><div class="line">        D(<span class="string">"No node given!"</span>);</div><div class="line">        new_node = quicklistCreateNode();</div><div class="line">        new_node-&gt;zl = ziplistPush(ziplistNew(), value, sz, ZIPLIST_HEAD);</div><div class="line">        __quicklistInsertNode(quicklist, <span class="literal">NULL</span>, new_node, after);</div><div class="line">        new_node-&gt;count++;</div><div class="line">        quicklist-&gt;count++;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">/* Populate accounting flags for easier boolean checks later</span></div><div class="line">     *</div><div class="line">     * 判断压缩列表是否还能存入新节点，插入的位置在表头或者表尾</div><div class="line">     */</div><div class="line">    <span class="keyword">if</span> (!_quicklistNodeAllowInsert(node, fill, sz)) &#123;</div><div class="line">        D(<span class="string">"Current node is full with count %d with requested fill %lu"</span>,</div><div class="line">          node-&gt;count, fill);</div><div class="line">        full = <span class="number">1</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (after &amp;&amp; (entry-&gt;offset == node-&gt;count)) &#123;</div><div class="line">        D(<span class="string">"At Tail of current ziplist"</span>);</div><div class="line">        at_tail = <span class="number">1</span>;</div><div class="line">        <span class="keyword">if</span> (!_quicklistNodeAllowInsert(node-&gt;next, fill, sz)) &#123;</div><div class="line">            D(<span class="string">"Next node is full too."</span>);</div><div class="line">            full_next = <span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (!after &amp;&amp; (entry-&gt;offset == <span class="number">0</span>)) &#123;</div><div class="line">        D(<span class="string">"At Head"</span>);</div><div class="line">        at_head = <span class="number">1</span>;</div><div class="line">        <span class="keyword">if</span> (!_quicklistNodeAllowInsert(node-&gt;prev, fill, sz)) &#123;</div><div class="line">            D(<span class="string">"Prev node is full too."</span>);</div><div class="line">            full_prev = <span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">/* Now determine where and how to insert the new element</span></div><div class="line">     *</div><div class="line">     * 判断该如何插入节点</div><div class="line">     */</div><div class="line">    <span class="keyword">if</span> (!full &amp;&amp; after) &#123;</div><div class="line">        D(<span class="string">"Not full, inserting after current position."</span>);</div><div class="line">        quicklistDecompressNodeForUse(node);</div><div class="line">        <span class="keyword">unsigned</span> <span class="keyword">char</span> *next = ziplistNext(node-&gt;zl, entry-&gt;zi);</div><div class="line">        <span class="comment">// 判断是否在压缩列表的表尾插入</span></div><div class="line">        <span class="keyword">if</span> (next == <span class="literal">NULL</span>) &#123;</div><div class="line">            node-&gt;zl = ziplistPush(node-&gt;zl, value, sz, ZIPLIST_TAIL);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            node-&gt;zl = ziplistInsert(node-&gt;zl, next, value, sz);</div><div class="line">        &#125;</div><div class="line">        node-&gt;count++;</div><div class="line">        quicklistNodeUpdateSz(node);</div><div class="line">        quicklistRecompressOnly(quicklist, node);</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!full &amp;&amp; !after) &#123;</div><div class="line">        D(<span class="string">"Not full, inserting before current position."</span>);</div><div class="line">        quicklistDecompressNodeForUse(node);</div><div class="line">        node-&gt;zl = ziplistInsert(node-&gt;zl, entry-&gt;zi, value, sz);</div><div class="line">        node-&gt;count++;</div><div class="line">        quicklistNodeUpdateSz(node);</div><div class="line">        quicklistRecompressOnly(quicklist, node);</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (full &amp;&amp; at_tail &amp;&amp; node-&gt;next &amp;&amp; !full_next &amp;&amp; after) &#123;</div><div class="line">        <span class="comment">/* If we are: at tail, next has free space, and inserting after:</span></div><div class="line">         *   - insert entry at head of next node.</div><div class="line">         *</div><div class="line">         * 如果当前压缩列表已满，而后一个节点未满，且插入在当前压缩列表的表尾，则插入到后一个节点表头</div><div class="line">         */</div><div class="line">        D(<span class="string">"Full and tail, but next isn't full; inserting next node head"</span>);</div><div class="line">        new_node = node-&gt;next;</div><div class="line">        quicklistDecompressNodeForUse(new_node);</div><div class="line">        new_node-&gt;zl = ziplistPush(new_node-&gt;zl, value, sz, ZIPLIST_HEAD);</div><div class="line">        new_node-&gt;count++;</div><div class="line">        quicklistNodeUpdateSz(new_node);</div><div class="line">        quicklistRecompressOnly(quicklist, new_node);</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (full &amp;&amp; at_head &amp;&amp; node-&gt;prev &amp;&amp; !full_prev &amp;&amp; !after) &#123;</div><div class="line">        <span class="comment">/* If we are: at head, previous has free space, and inserting before:</span></div><div class="line">         *   - insert entry at tail of previous node.</div><div class="line">         *</div><div class="line">         * 如果当前压缩列表已满，而前一个节点未满，且插入在当前压缩列表的表头，则插入到前一个节点表尾</div><div class="line">         */</div><div class="line">        D(<span class="string">"Full and head, but prev isn't full, inserting prev node tail"</span>);</div><div class="line">        new_node = node-&gt;prev;</div><div class="line">        quicklistDecompressNodeForUse(new_node);</div><div class="line">        new_node-&gt;zl = ziplistPush(new_node-&gt;zl, value, sz, ZIPLIST_TAIL);</div><div class="line">        new_node-&gt;count++;</div><div class="line">        quicklistNodeUpdateSz(new_node);</div><div class="line">        quicklistRecompressOnly(quicklist, new_node);</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (full &amp;&amp; ((at_tail &amp;&amp; node-&gt;next &amp;&amp; full_next &amp;&amp; after) ||</div><div class="line">                        (at_head &amp;&amp; node-&gt;prev &amp;&amp; full_prev &amp;&amp; !after))) &#123;</div><div class="line">        <span class="comment">/* If we are: full, and our prev/next is full, then:</span></div><div class="line">         *   - create new node and attach to quicklist</div><div class="line">         * 如果插入在压缩列表的表头或表尾，且前后节点也已满，则创建新快速列表节点</div><div class="line">         */</div><div class="line">        D(<span class="string">"\tprovisioning new node..."</span>);</div><div class="line">        new_node = quicklistCreateNode();</div><div class="line">        new_node-&gt;zl = ziplistPush(ziplistNew(), value, sz, ZIPLIST_HEAD);</div><div class="line">        new_node-&gt;count++;</div><div class="line">        quicklistNodeUpdateSz(new_node);</div><div class="line">        __quicklistInsertNode(quicklist, node, new_node, after);</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (full) &#123;</div><div class="line">        <span class="comment">/* else, node is full we need to split it.</span></div><div class="line">         * covers both after and !after cases</div><div class="line">         *</div><div class="line">         * 如果不是在两端，则将当前的节点进行拆分后再进行插入</div><div class="line">         */</div><div class="line">        D(<span class="string">"\tsplitting node..."</span>);</div><div class="line">        quicklistDecompressNodeForUse(node);</div><div class="line">        new_node = _quicklistSplitNode(node, entry-&gt;offset, after);</div><div class="line">        new_node-&gt;zl = ziplistPush(new_node-&gt;zl, value, sz,</div><div class="line">                                   after ? ZIPLIST_HEAD : ZIPLIST_TAIL);</div><div class="line">        new_node-&gt;count++;</div><div class="line">        quicklistNodeUpdateSz(new_node);</div><div class="line">        __quicklistInsertNode(quicklist, node, new_node, after);</div><div class="line">        _quicklistMergeNodes(quicklist, node);</div><div class="line">    &#125;</div><div class="line">    quicklist-&gt;count++;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">quicklistInsertBefore</span><span class="params">(quicklist *quicklist, quicklistEntry *entry,</span></span></div><div class="line">                           <span class="keyword">void</span> *value, <span class="keyword">const</span> <span class="keyword">size_t</span> sz) &#123;</div><div class="line">    _quicklistInsert(quicklist, entry, value, sz, <span class="number">0</span>);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">quicklistInsertAfter</span><span class="params">(quicklist *quicklist, quicklistEntry *entry,</span></span></div><div class="line">                          <span class="keyword">void</span> *value, <span class="keyword">const</span> <span class="keyword">size_t</span> sz) &#123;</div><div class="line">    _quicklistInsert(quicklist, entry, value, sz, <span class="number">1</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="迭代器"><a href="#迭代器" class="headerlink" title="迭代器"></a>迭代器</h3><p>快速列表定义了迭代器和压缩列表节点结构，并且可以从表头和表尾两个方向对所有的压缩列表中的节点进行遍历，具体的数据结构定义如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 快速列表的迭代器，用于遍历快速列表中所有压缩列表的所有节点，按照每个压缩列表节点进行遍历</span></div><div class="line"><span class="comment">// 可以选择遍历压缩列表的方向，从头遍历 AL_START_HEAD 或者从尾遍历 AL_START_TAIL</span></div><div class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">quicklistIter</span> &#123;</span></div><div class="line">    <span class="keyword">const</span> quicklist *quicklist;    <span class="comment">// 遍历的快速列表指针</span></div><div class="line">    quicklistNode *current;        <span class="comment">// 遍历的快速列表节点指针</span></div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *zi;             <span class="comment">// 遍历到的压缩列表节点的指针</span></div><div class="line">    <span class="keyword">long</span> offset;                   <span class="comment">// 遍历到的压缩列表节点的偏移量</span></div><div class="line">    <span class="keyword">int</span> direction;                 <span class="comment">// 遍历方向 AL_START_HEAD 或 AL_START_TAIL</span></div><div class="line">&#125; quicklistIter;</div><div class="line"><span class="comment">// 快速列表迭代过程中取出的压缩列表节点的结构</span></div><div class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">quicklistEntry</span> &#123;</span></div><div class="line">    <span class="keyword">const</span> quicklist *quicklist;    <span class="comment">// 快速列表指针</span></div><div class="line">    quicklistNode *node;           <span class="comment">// 快速列表的节点指针</span></div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *zi;             <span class="comment">// 压缩列表节点的指针</span></div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *value;          <span class="comment">// 压缩列表节点的字符串指针（如果内容无法保存到 longval 的话）</span></div><div class="line">    <span class="keyword">long</span> <span class="keyword">long</span> longval;             <span class="comment">// 压缩列表节点的数值</span></div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> sz;               <span class="comment">// 压缩列表节点的字符串长度</span></div><div class="line">    <span class="keyword">int</span> offset;                    <span class="comment">// 压缩列表节点的索引值，如果从后向前遍历时，为负数</span></div><div class="line">&#125; quicklistEntry;</div></pre></td></tr></table></figure>
<p>以下是具体的遍历代码，在进行遍历的过程中，会逐一取出压缩列表的节点，若节点被压缩，则进行解压，同时标注 recompress 为 1，以待该节点被使用完以后重新压缩。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">quicklistNext</span><span class="params">(quicklistIter *iter, quicklistEntry *entry)</span> </span>&#123;</div><div class="line">    initEntry(entry);</div><div class="line">    <span class="keyword">if</span> (!iter) &#123;</div><div class="line">        D(<span class="string">"Returning because no iter!"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 从迭代器里获得当前压缩节点对应的快速列表信息</span></div><div class="line">    entry-&gt;quicklist = iter-&gt;quicklist;</div><div class="line">    entry-&gt;node = iter-&gt;current;</div><div class="line">    <span class="comment">// 如果当前的快速列表的节点为空，则返回</span></div><div class="line">    <span class="keyword">if</span> (!iter-&gt;current) &#123;</div><div class="line">        D(<span class="string">"Returning because current node is NULL"</span>)</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 定义一个函数指针，后面将根据遍历的方向决定具体的实现</span></div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *(*nextFn)(<span class="keyword">unsigned</span> <span class="keyword">char</span> *, <span class="keyword">unsigned</span> <span class="keyword">char</span> *) = <span class="literal">NULL</span>;</div><div class="line">    <span class="keyword">int</span> offset_update = <span class="number">0</span>;</div><div class="line">    <span class="comment">// 如果已经有对应的指针，则说明在遍历一个压缩列表没有结束，这时候可以直接使用，否则需要解压一个快速列表的节点，然后查找对应的节点</span></div><div class="line">    <span class="keyword">if</span> (!iter-&gt;zi) &#123;</div><div class="line">        <span class="comment">/* If !zi, use current index.</span></div><div class="line">         *</div><div class="line">         * 上一个压缩列表已经遍历完了，现在要遍历一个新的快速列表节点对应的压缩列表</div><div class="line">         */</div><div class="line">        quicklistDecompressNodeForUse(iter-&gt;current);</div><div class="line">        iter-&gt;zi = ziplistIndex(iter-&gt;current-&gt;zl, iter-&gt;offset);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">/* else, use existing iterator offset and get prev/next as necessary.</span></div><div class="line">         *</div><div class="line">         * 获取下一个节点的指针和偏移量</div><div class="line">         */</div><div class="line">        <span class="keyword">if</span> (iter-&gt;direction == AL_START_HEAD) &#123;</div><div class="line">            nextFn = ziplistNext;</div><div class="line">            offset_update = <span class="number">1</span>;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (iter-&gt;direction == AL_START_TAIL) &#123;</div><div class="line">            nextFn = ziplistPrev;</div><div class="line">            offset_update = <span class="number">-1</span>;</div><div class="line">        &#125;</div><div class="line">        iter-&gt;zi = nextFn(iter-&gt;current-&gt;zl, iter-&gt;zi);</div><div class="line">        iter-&gt;offset += offset_update;</div><div class="line">    &#125;</div><div class="line">    entry-&gt;zi = iter-&gt;zi;</div><div class="line">    entry-&gt;offset = iter-&gt;offset;</div><div class="line">    <span class="keyword">if</span> (iter-&gt;zi) &#123;</div><div class="line">        <span class="comment">/* Populate value from existing ziplist position</span></div><div class="line">         *</div><div class="line">         * 如果当前的压缩列表没有遍历完成，则取出对应的节点的值</div><div class="line">         */</div><div class="line">        ziplistGet(entry-&gt;zi, &amp;entry-&gt;value, &amp;entry-&gt;sz, &amp;entry-&gt;longval);</div><div class="line">        <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">/* We ran out of ziplist entries.</span></div><div class="line">         * Pick next node, update offset, then re-run retrieval.</div><div class="line">         *</div><div class="line">         * 将遍历完的节点压缩，然后按照遍历方向进行下一个快速列表节点对应的压缩列表的遍历</div><div class="line">         */</div><div class="line">        quicklistCompress(iter-&gt;quicklist, iter-&gt;current);</div><div class="line">        <span class="keyword">if</span> (iter-&gt;direction == AL_START_HEAD) &#123;</div><div class="line">            <span class="comment">/* Forward traversal */</span></div><div class="line">            D(<span class="string">"Jumping to start of next node"</span>);</div><div class="line">            iter-&gt;current = iter-&gt;current-&gt;next;</div><div class="line">            iter-&gt;offset = <span class="number">0</span>;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (iter-&gt;direction == AL_START_TAIL) &#123;</div><div class="line">            <span class="comment">/* Reverse traversal */</span></div><div class="line">            D(<span class="string">"Jumping to end of previous node"</span>);</div><div class="line">            iter-&gt;current = iter-&gt;current-&gt;prev;</div><div class="line">            iter-&gt;offset = <span class="number">-1</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// 获取新的压缩列表的第一个遍历节点（根据遍历方向，有可能是头节点，也可能是尾节点）</span></div><div class="line">        iter-&gt;zi = <span class="literal">NULL</span>;</div><div class="line">        <span class="keyword">return</span> quicklistNext(iter, entry);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>快速列表的主要操作都在上面进行了叙述，其它的操作可以查看相应的源代码注释。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/11/12/redis_skip_list/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="柿子">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="柿子的果盘">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/11/12/redis_skip_list/" itemprop="url">Redis数据结构: 跳跃表</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-11-12T00:00:00+08:00">
                2016-11-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/开源项目/" itemprop="url" rel="index">
                    <span itemprop="name">开源项目</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2016/11/12/redis_skip_list/" class="leancloud_visitors" data-flag-title="Redis数据结构: 跳跃表">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>对于普通的链表而言，即使包含的元素是有序的，包括查找在内的各项操作的时间复杂度也是 O(N)，并没有使用有序的特性。而跳跃表则是对于链表的改良，通过增加额外的空间，使得各项操作的时间复杂度降低。</p>
<p>与双端链表和哈希表相比，跳跃表这个概念大部分人都会觉得陌生一些，之前学数据结构的时候学过，但从来没有使用过，现在看到 Redis 里面实现的跳跃表，就把这个数据结构温习一下，在这边也做个介绍。跳跃表通过对有序链表的每个节点增加一些前进链接，获得快速查找访问节点的能力。下图是一个跳跃表的示例（来自百度百科）：</p>
<p><img src="http://ocx5ae9jo.bkt.clouddn.com/skip-list-example.jpg" width="500px;" height="200px;"></p>
<p>跳跃表是按层建造的。底层是一个普通的有序链表。每个更高层的构建都是为了跳跃若干个节点更快地定位到需要查找的节点。在构建跳跃表的时候，设定每层会向上增长的概率为 1 / p，则第 m 层向上增长的概率为 1 / p^m；假设链表中的元素个数为 n，则在 m 层元素数目的期望是 n / p^m；当这个数量为 1 时，m = log p(n) 即为层数。而将所有的层上的节点数量相加，即 n + n / p + …… + 1 &lt; 2 n，因此跳跃表的空间复杂度是 O(N)。对于一个节点而言，它恰好层数等于 1 的概率为 1 - p，层数等于 2 的概率为 p (1 - p)，层数等于 3 的概率为 p^2 (1 - p)，因此，一个节点的平均层数为 1 (1 - p) + 2 p (1 - p) + 3 p^2 (1 - p) + … = 1 / (1 - p)，这就是一个节点对应的指针数量。<br>跳跃列表的时间复杂度的分析比较复杂，这边只给结论，它的平均时间复杂度为 O(log n)。具体的推导过程可以查看 William Pugh 的论文 <a href="ftp://ftp.cs.umd.edu/pub/skipLists/skiplists.pdf" target="_blank" rel="external">Skip Lists: A Probabilistic Alternative to Balanced Trees</a>。</p>
<p>可能也有人会问，各类的平衡树也可以用类似的时间复杂度来实现同样的功能，那么为什么 Redis 不用平衡树呢？具体的比较如下：</p>
<ul>
<li>在做范围查找的时候，平衡树比跳跃表操作要复杂。在平衡树上，我们找到指定范围的小值之后，还需要以中序遍历的顺序继续寻找其它不超过大值的节点。如果不对平衡树进行一定的改造，这里的中序遍历并不容易实现。而在skiplist上进行范围查找就非常简单，只需要在找到小值之后，对第1层链表进行若干步的遍历就可以实现。</li>
<li>平衡树的插入和删除操作可能引发子树的调整，逻辑复杂，而skiplist的插入和删除只需要修改相邻节点的指针，操作简单又快速。</li>
<li>从内存占用上来说，跳跃表比平衡树更灵活一些。一般来说，平衡树每个节点包含2个指针（分别指向左右子树），而跳跃表每个节点包含的指针数目平均为 1 / (1 - p)，具体取决于参数 p 的大小。在 Redis 实现时，p = 1 / 4，那么平均每个节点包含 1.33 个指针，所需要的存储空间比平衡树更小。</li>
<li>跳跃表的实现比平衡树更简单。</li>
</ul>
<p>基于上述的考虑，Redis 采用了性能相似，但在存储空间更节省，时间复杂度更低的跳跃表来进行有序元素的存储。</p>
<h3 id="基本结构"><a href="#基本结构" class="headerlink" title="基本结构"></a>基本结构</h3><p>在 server.h 中定义了跳跃表的节点结构：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">zskiplistNode</span> &#123;</span></div><div class="line">    sds ele;                                <span class="comment">// 字符串指针</span></div><div class="line">    <span class="keyword">double</span> score;                           <span class="comment">// 分值</span></div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">zskiplistNode</span> *<span class="title">backward</span>;</span>         <span class="comment">// 后退指针</span></div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">zskiplistLevel</span> &#123;</span></div><div class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">zskiplistNode</span> *<span class="title">forward</span>;</span>      <span class="comment">// 前进指针</span></div><div class="line">        <span class="keyword">unsigned</span> <span class="keyword">int</span> span;                  <span class="comment">// 跨度</span></div><div class="line">    &#125; level[];                              <span class="comment">// 该结点出现在的不同层</span></div><div class="line">&#125; zskiplistNode;</div></pre></td></tr></table></figure>
<p>在这个结构中，定义了跳跃表需要的一些基本属性：成员对象、分值和不同层的前进指针和跨度。另外，多定义了一个后退指针，主要是为了能够从表尾开始遍历整个链表。另外，由于在 Redis 中跳跃表的作用比较有限，所以在最新的版本中，把跳跃表的成员对象的类型改为 sds。</p>
<p>在经典的跳跃表中，只需要使用上述定义的节点结构就可以实现跳跃表。但是为了方便诸如节点数量查询，从表尾遍历等操作，定义了一个结构存储链表的一些相关信息，具体如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">zskiplist</span> &#123;</span></div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">zskiplistNode</span> *<span class="title">header</span>, *<span class="title">tail</span>;</span>    <span class="comment">// 表头节点和表尾节点</span></div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> length;                   <span class="comment">// 表中节点的数量</span></div><div class="line">    <span class="keyword">int</span> level;                              <span class="comment">// 表中层数最大的节点的层数</span></div><div class="line">&#125; zskiplist;</div></pre></td></tr></table></figure>
<h3 id="各类操作"><a href="#各类操作" class="headerlink" title="各类操作"></a>各类操作</h3><p>在上述定义的结构中，我们可以进行链表相关的各类操作，由于添加操作中包含查询的相关逻辑，因此，我们就来看看添加操作的代码，查询元素，或者按照排位查询元素的逻辑也基本类似。<br>添加操作的代码在 tzset.c 中，这个操作的平均时间复杂度为 O(log N)，最差的时间复杂度为 O(N)，具体的细节参见代码的注释：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div></pre></td><td class="code"><pre><div class="line"><span class="function">zskiplistNode *<span class="title">zslInsert</span><span class="params">(zskiplist *zsl, <span class="keyword">double</span> score, robj *obj)</span> </span>&#123;</div><div class="line">    zskiplistNode *update[ZSKIPLIST_MAXLEVEL], *x;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> rank[ZSKIPLIST_MAXLEVEL];</div><div class="line">    <span class="keyword">int</span> i, level;</div><div class="line">    redisAssert(!isnan(score));</div><div class="line">    <span class="comment">// 在各个层查找节点的插入位置</span></div><div class="line">    x = zsl-&gt;header;</div><div class="line">    <span class="keyword">for</span> (i = zsl-&gt;level<span class="number">-1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</div><div class="line">        <span class="comment">// 如果 i 不是 zsl-&gt;level-1 层，那么 i 层的起始 rank 值为 i+1 层的 rank 值</span></div><div class="line">        <span class="comment">// 最终 rank[0] 的值加一就是新节点的前置节点的排位</span></div><div class="line">        rank[i] = i == (zsl-&gt;level<span class="number">-1</span>) ? <span class="number">0</span> : rank[i+<span class="number">1</span>];</div><div class="line">        <span class="comment">// 沿着前进指针遍历跳跃表</span></div><div class="line">        <span class="keyword">while</span> (x-&gt;level[i].forward &amp;&amp;</div><div class="line">            (x-&gt;level[i].forward-&gt;score &lt; score ||</div><div class="line">                <span class="comment">// 比对分值</span></div><div class="line">                (x-&gt;level[i].forward-&gt;score == score &amp;&amp;</div><div class="line">                <span class="comment">// 比对成员， T = O(N)</span></div><div class="line">                compareStringObjects(x-&gt;level[i].forward-&gt;obj,obj) &lt; <span class="number">0</span>))) &#123;</div><div class="line">            <span class="comment">// 记录沿途跨越了多少个节点</span></div><div class="line">            rank[i] += x-&gt;level[i].span;</div><div class="line">            <span class="comment">// 移动至下一指针</span></div><div class="line">            x = x-&gt;level[i].forward;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// 记录将要和新节点相连接的节点</span></div><div class="line">        update[i] = x;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">/*</span></div><div class="line">     * zslInsert() 的调用者会确保同分值且同成员的元素不会出现，</div><div class="line">     * 所以这里不需要进一步进行检查，可以直接创建新元素。</div><div class="line">     */</div><div class="line">    <span class="comment">// 获取一个随机值作为新节点的层数，</span></div><div class="line">    level = zslRandomLevel();</div><div class="line">    <span class="comment">// 如果新节点的层数比表中其他节点的层数都要大</span></div><div class="line">    <span class="comment">// 那么初始化表头节点中未使用的层，并将它们记录到 update 数组中</span></div><div class="line">    <span class="comment">// 将来也指向新节点</span></div><div class="line">    <span class="keyword">if</span> (level &gt; zsl-&gt;level) &#123;</div><div class="line">        <span class="comment">// 初始化未使用层</span></div><div class="line">        <span class="keyword">for</span> (i = zsl-&gt;level; i &lt; level; i++) &#123;</div><div class="line">            rank[i] = <span class="number">0</span>;</div><div class="line">            update[i] = zsl-&gt;header;</div><div class="line">            update[i]-&gt;level[i].span = zsl-&gt;length;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// 更新表中节点最大层数</span></div><div class="line">        zsl-&gt;level = level;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 创建新节点</span></div><div class="line">    x = zslCreateNode(level,score,obj);</div><div class="line">    <span class="comment">// 将前面记录的指针指向新节点，并做相应的设置</span></div><div class="line">    <span class="comment">// T = O(1)</span></div><div class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; level; i++) &#123;</div><div class="line"></div><div class="line">        <span class="comment">// 设置新节点的 forward 指针</span></div><div class="line">        x-&gt;level[i].forward = update[i]-&gt;level[i].forward;</div><div class="line"></div><div class="line">        <span class="comment">// 将沿途记录的各个节点的 forward 指针指向新节点</span></div><div class="line">        update[i]-&gt;level[i].forward = x;</div><div class="line">        <span class="comment">/* update span covered by update[i] as x is inserted here */</span></div><div class="line">        <span class="comment">// 计算新节点跨越的节点数量</span></div><div class="line">        x-&gt;level[i].span = update[i]-&gt;level[i].span - (rank[<span class="number">0</span>] - rank[i]);</div><div class="line">        <span class="comment">// 更新新节点插入之后，沿途节点的 span 值</span></div><div class="line">        <span class="comment">// 其中的 +1 计算的是新节点</span></div><div class="line">        update[i]-&gt;level[i].span = (rank[<span class="number">0</span>] - rank[i]) + <span class="number">1</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">/* increment span for untouched levels */</span></div><div class="line">    <span class="comment">// 未接触的节点的 span 值也需要增一，这些节点直接从表头指向新节点</span></div><div class="line">    <span class="comment">// T = O(1)</span></div><div class="line">    <span class="keyword">for</span> (i = level; i &lt; zsl-&gt;level; i++) &#123;</div><div class="line">        update[i]-&gt;level[i].span++;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 设置新节点的后退指针</span></div><div class="line">    x-&gt;backward = (update[<span class="number">0</span>] == zsl-&gt;header) ? <span class="literal">NULL</span> : update[<span class="number">0</span>];</div><div class="line">    <span class="keyword">if</span> (x-&gt;level[<span class="number">0</span>].forward)</div><div class="line">        x-&gt;level[<span class="number">0</span>].forward-&gt;backward = x;</div><div class="line">    <span class="keyword">else</span></div><div class="line">        zsl-&gt;tail = x;</div><div class="line">    <span class="comment">// 跳跃表的节点计数增一</span></div><div class="line">    zsl-&gt;length++;</div><div class="line">    <span class="keyword">return</span> x;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>此外，Redis 实现的跳跃表除了常规的链表操作以外，还增加了一些与范围相关的操作，具体的实现方式与上述的添加操作也类似。Redis 定义的范围有两种，一种是按照数值的大小定义的区间，另一种是按照字典序的先后定义的区间，跳跃表对于这两种范围都定义了操作。主要的操作有：判断给定的节点是否在范围中，范围中的第一个节点或最后一个节点，以及删除范围中的所有节点。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.jpg"
               alt="柿子" />
          <p class="site-author-name" itemprop="name">柿子</p>
           
              <p class="site-description motion-element" itemprop="description">一个非主流程序员</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">19</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">5</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">7</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">柿子</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.1"></script>



  
    <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  




	





  





  





  






  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("m5cJ6uWE1c1GaX65w4A1DubN-gzGzoHsz", "kI8J0OH8eDBG6WdG10XRj37j");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  

  

  

</body>
</html>
